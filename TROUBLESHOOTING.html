<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>PBX System - Troubleshooting Guide</title>
    <style>

        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background-color: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
            margin-top: 0;
        }
        
        h2 {
            color: #34495e;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 8px;
            margin-top: 30px;
        }
        
        h3 {
            color: #555;
            margin-top: 25px;
        }
        
        h4 {
            color: #666;
            margin-top: 20px;
        }
        
        code {
            background-color: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
            color: #e74c3c;
        }
        
        pre {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 15px 0;
        }
        
        pre code {
            background-color: transparent;
            color: inherit;
            padding: 0;
            font-size: 0.95em;
        }
        
        .code-block.bash code,
        .code-block.sh code {
            color: #2ecc71;
        }
        
        .code-block.yaml code,
        .code-block.yml code {
            color: #f39c12;
        }
        
        .code-block.python code {
            color: #3498db;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        table.info-table {
            background-color: white;
        }
        
        th {
            background-color: #3498db;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }
        
        td {
            padding: 10px 12px;
            border: 1px solid #ddd;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        tr:hover {
            background-color: #f0f0f0;
        }
        
        a {
            color: #3498db;
            text-decoration: none;
        }
        
        a:hover {
            text-decoration: underline;
            color: #2980b9;
        }
        
        hr {
            border: none;
            border-top: 2px solid #ecf0f1;
            margin: 30px 0;
        }
        
        ul, ol {
            margin: 10px 0;
            padding-left: 30px;
        }
        
        li {
            margin: 5px 0;
        }
        
        strong {
            color: #2c3e50;
            font-weight: 600;
        }
        
        p {
            margin: 10px 0;
        }
        
        .toc {
            background-color: #ecf0f1;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
        }
        
        .toc ul {
            list-style-type: none;
            padding-left: 0;
        }
        
        .toc li {
            margin: 8px 0;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 0.85em;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .status-fixed {
            background-color: #2ecc71;
            color: white;
        }
        
        .status-documented {
            background-color: #3498db;
            color: white;
        }
        
        @media print {
            body {
                background-color: white;
            }
            
            .container {
                box-shadow: none;
            }
            
            pre {
                background-color: #f4f4f4;
                color: #333;
                border: 1px solid #ddd;
            }
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 20px;
            }
            
            table {
                font-size: 0.9em;
            }
        }
    
    </style>
</head>
<body>
    <div class="container">
<h1 id="pbx-system-comprehensive-troubleshooting-guide">PBX System - Comprehensive Troubleshooting Guide</h1>

<strong>Version:</strong> 1.0.0  
<strong>Last Updated:</strong> 2025-12-29  
<strong>For Administrators and Support Staff</strong>

<p>This comprehensive guide covers all known issues, solutions, and troubleshooting procedures for the Warden VoIP PBX system.</p>

<hr>

<h2 id="table-of-contents">Table of Contents</h2>

<ol>
<li><a href="#quick-reference">Quick Reference</a></li>
<li><a href="#audio-issues">Audio Issues</a></li>
<li><a href="#registration--connectivity">Registration & Connectivity</a></li>
<li><a href="#admin-panel-issues">Admin Panel Issues</a></li>
<li><a href="#integration-problems">Integration Problems</a></li>
<li><a href="#phone-provisioning">Phone Provisioning</a></li>
<li><a href="#database-issues">Database Issues</a></li>
<li><a href="#service-management">Service Management</a></li>
<li><a href="#network--firewall">Network & Firewall</a></li>
<li><a href="#configuration-issues">Configuration Issues</a></li>
<li><a href="#performance--monitoring">Performance & Monitoring</a></li>
<li><a href="#historical-fixes-reference">Historical Fixes Reference</a></li>
</ol>

<hr>

<h2 id="quick-reference">Quick Reference</h2>

<table class="info-table">
<thead><tr>
<th>Issue</th>
<th>Quick Fix</th>
<th>Section</th>
</tr></thead>
<tbody>
<tr>
<td>No audio in calls</td>
<td><code>sudo ufw allow 10000:20000/udp</code></td>
<td><a href="#audio-issues">Audio Issues</a></td>
</tr>
<tr>
<td>Phones won't register</td>
<td><code>sudo ufw allow 5060/udp</code></td>
<td><a href="#registration--connectivity">Registration</a></td>
</tr>
<tr>
<td>Admin panel login fails</td>
<td><code>Ctrl+Shift+R</code> then check <code>systemctl status pbx</code></td>
<td><a href="#admin-panel-issues">Admin Panel</a></td>
</tr>
<tr>
<td>ERR_SSL_PROTOCOL_ERROR</td>
<td>Set <code>api.ssl.enabled: false</code> in config.yml</td>
<td><a href="#err_ssl_protocol_error-with-reverse-proxy">Admin Panel</a></td>
</tr>
<tr>
<td>Email not sending</td>
<td><code>python -c "import smtplib; s=smtplib.SMTP('localhost', 25); print(s.ehlo()); s.quit()"</code></td>
<td><a href="#integration-problems">Integration Problems</a></td>
</tr>
<tr>
<td>Database errors</td>
<td><code>python scripts/verify_database.py</code></td>
<td><a href="#database-issues">Database Issues</a></td>
</tr>
<tr>
<td>Voice prompts missing</td>
<td><code>python scripts/generate_tts_prompts.py</code></td>
<td><a href="#audio-issues">Audio Issues</a></td>
</tr>
<tr>
<td>Phone won't provision</td>
<td>Check DHCP Option 66 or manual server</td>
<td><a href="#phone-provisioning">Phone Provisioning</a></td>
</tr>
<tr>
<td>High CPU usage</td>
<td>Check active calls, restart service</td>
<td><a href="#performance--monitoring">Performance</a></td>
</tr>
</tbody>
</table>

<hr>

<h2 id="audio-issues">Audio Issues</h2>

<h3 id="no-audio-in-phone-calls">No Audio in Phone Calls</h3>

<strong>Symptoms:</strong>
<ul>
<li>Phones connect but no audio in either direction</li>
<li>Silent calls or one-way audio</li>
<li>Call establishes but no voice transmission</li>
</ul>

<strong>Root Causes:</strong>
<ol>
<li><strong>RTP Firewall Blocked</strong> (Most Common)</li>
<li><strong>Codec Mismatch</strong></li>
<li><strong>RTP Relay Issues</strong></li>
<li><strong>NAT/Network Issues</strong></li>
</ol>

<strong>Solutions:</strong>

<strong>1. Check RTP Firewall Rules:</strong>
<p>``<code>bash</p>
<h1 id="open-rtp-port-range">Open RTP port range</h1>
<p>sudo ufw allow 10000:20000/udp</p>

<h1 id="verify-firewall-status">Verify firewall status</h1>
<p>sudo ufw status numbered</p>

<h1 id="should-see">Should see:</h1>
<h1 id="1000020000udp-allow-in-anywhere">10000:20000/udp ALLOW IN  Anywhere</h1>
</code>`<code>

<strong>2. Verify Codec Compatibility:</strong>
</code>`<code>bash
<h1 id="check-configyml">Check config.yml</h1>
<p>grep -A 10 "codecs:" config.yml</p>

<h1 id="ensure-phones-support-enabled-codecs">Ensure phones support enabled codecs</h1>
<h1 id="common-codecs-pcmu-pcma-g722-opus">Common codecs: PCMU, PCMA, G722, Opus</h1>
</code>`<code>

<strong>3. Check RTP Relay Logs:</strong>
</code>`<code>bash
<p>tail -f logs/pbx.log | grep RTP</p>

<h1 id="should-see">Should see:</h1>
<h1 id="rtp-relay-allocated-on-port-xxxxx">"RTP relay allocated on port XXXXX"</h1>
<h1 id="relayed-xxx-bytes-a-b">"Relayed XXX bytes: A->B"</h1>
<h1 id="relayed-xxx-bytes-b-a">"Relayed XXX bytes: B->A"</h1>
</code>`<code>

<strong>4. Test Audio Path:</strong>
</code>`<code>bash
<h1 id="make-test-call-between-extensions">Make test call between extensions</h1>
<h1 id="check-both-directions">Check both directions</h1>

<h1 id="view-siprtp-debug">View SIP/RTP debug</h1>
<p>tail -f logs/pbx.log | grep -E "(SIP|RTP)"</p>
</code>`<code>

<strong>5. Network/NAT Issues:</strong>
</code>`<code>bash
<h1 id="if-behind-nat-configure-external-ip-in-configyml">If behind NAT, configure external IP in config.yml</h1>
<p>external_ip: "YOUR_PUBLIC_IP"</p>

<h1 id="verify-rtp-can-traverse-nat">Verify RTP can traverse NAT</h1>
<h1 id="may-need-stunturn-configuration">May need STUN/TURN configuration</h1>
</code>`<code>

<h3 id="distorted-or-garbled-audio">Distorted or Garbled Audio</h3>

<strong>Status:</strong> ✅ <strong>FIXED</strong> (December 19, 2025)

<strong>Symptoms:</strong>
<ul>
<li>Audio plays but sounds distorted, robotic, or garbled</li>
<li>TTS prompts sound incorrect</li>
<li>Voicemail playback is unintelligible</li>
<li>High-pitched or low-pitched audio</li>
</ul>

<strong>Root Cause:</strong>
<p>Audio sample rate mismatch - voicemail prompt files were generated at 16kHz but system expects 8kHz for PCMU codec.</p>

<strong>Solution Applied:</strong>
<p>All voicemail and auto attendant prompts have been regenerated at the correct 8kHz sample rate.</p>

<strong>If Issues Persist:</strong>
</code>`<code>bash
<h1 id="regenerate-audio-prompts-at-correct-sample-rate">Regenerate audio prompts at correct sample rate</h1>
<p>python scripts/generate_tts_prompts.py</p>

<h1 id="verify-generated-files">Verify generated files</h1>
<p>file voicemail_prompts/*.wav</p>
<h1 id="should-show-riff-little-endian-data-wave-audio-microsoft-pcm-8-bit-mono-8000-hz">Should show: "RIFF (little-endian) data, WAVE audio, Microsoft PCM, 8 bit, mono 8000 Hz"</h1>

<h1 id="check-auto-attendant-prompts">Check auto-attendant prompts</h1>
<p>file auto_attendant/*.wav</p>
</code>`<code>

<strong>Additional Verification:</strong>
</code>`<code>bash
<h1 id="test-specific-prompt">Test specific prompt</h1>
<p>play voicemail_prompts/beep.wav</p>

<h1 id="if-distorted-regenerate">If distorted, regenerate:</h1>
<p>python scripts/generate_tts_prompts.py --sample-rate 8000</p>

<h1 id="clear-cache-and-restart">Clear cache and restart</h1>
<p>sudo systemctl restart pbx</p>
</code>`<code>

<h3 id="no-audio-for-voicemailauto-attendant-prompts">No Audio for Voicemail/Auto-Attendant Prompts</h3>

<strong>Symptoms:</strong>
<ul>
<li>Voicemail IVR has no beeps or voice prompts</li>
<li>Auto attendant is silent</li>
<li>Caller hears silence when routed to voicemail</li>
</ul>

<strong>Root Causes & Solutions:</strong>

<strong>1. Missing Voice Prompt Files:</strong>
</code>`<code>bash
<h1 id="check-if-prompts-exist">Check if prompts exist</h1>
<p>ls -lh voicemail_prompts/</p>
<p>ls -lh auto_attendant/</p>

<h1 id="generate-if-missing">Generate if missing</h1>
<p>python scripts/generate_tts_prompts.py</p>

<h1 id="verify-files-were-created">Verify files were created</h1>
<p>ls -lh voicemail_prompts/*.wav</p>
<p>ls -lh auto_attendant/*.wav</p>
</code>`<code>

<strong>2. Incorrect File Permissions:</strong>
</code>`<code>bash
<h1 id="fix-permissions">Fix permissions</h1>
<p>sudo chown -R pbx:pbx voicemail_prompts/</p>
<p>sudo chown -R pbx:pbx auto_attendant/</p>
<p>sudo chmod 644 voicemail_prompts/*.wav</p>
<p>sudo chmod 644 auto_attendant/*.wav</p>
</code>`<code>

<strong>3. Codec Encoding Issues:</strong>
</code>`<code>bash
<h1 id="verify-file-encoding-matches-expected-codec">Verify file encoding matches expected codec</h1>
<h1 id="for-pcmu-g711-8khz-16-bit-mono">For PCMU (G.711): 8kHz, 16-bit, mono</h1>
<p>file voicemail_prompts/beep.wav</p>

<h1 id="if-wrong-format-regenerate-with-correct-parameters">If wrong format, regenerate with correct parameters</h1>
</code>`<code>

<strong>4. Check Logs for Errors:</strong>
</code>`<code>bash
<h1 id="look-for-file-not-found-or-playback-errors">Look for file not found or playback errors</h1>
<p>tail -f logs/pbx.log | grep -i "prompt\|wav\|audio"</p>
</code>`<code>

<h3 id="one-way-audio-can-hear-but-not-be-heard">One-Way Audio (Can Hear But Not Be Heard)</h3>

<strong>Symptoms:</strong>
<ul>
<li>One party can hear, other cannot</li>
<li>Asymmetric audio flow</li>
</ul>

<strong>Solutions:</strong>

<strong>1. NAT/Firewall Configuration:</strong>
</code>`<code>bash
<h1 id="ensure-symmetric-rtp-ports">Ensure symmetric RTP ports</h1>
<h1 id="check-nat-traversal-settings">Check NAT traversal settings</h1>

<h1 id="verify-both-directions-in-firewall">Verify both directions in firewall</h1>
<p>sudo ufw status | grep 10000:20000</p>
</code>`<code>

<strong>2. Check Codec Negotiation:</strong>
</code>`<code>bash
<h1 id="view-sip-session-details">View SIP session details</h1>
<p>tail -f logs/pbx.log | grep -A 20 "200 OK"</p>

<h1 id="verify-both-endpoints-agreed-on-same-codec">Verify both endpoints agreed on same codec</h1>
</code>`<code>

<strong>3. Phone Configuration:</strong>
<ul>
<li>Check phone's network settings</li>
<li>Verify NAT keepalive is enabled</li>
<li>Check phone's RTP port range matches PBX</li>
</ul>

<hr>

<h2 id="registration-connectivity">Registration & Connectivity</h2>

<h3 id="extensions-wont-register">Extensions Won't Register</h3>

<strong>Symptoms:</strong>
<ul>
<li>Phone shows "Not Registered" or "Registration Failed"</li>
<li>Extensions timeout during registration</li>
<li>Cannot make or receive calls</li>
</ul>

<strong>Solutions:</strong>

<strong>1. Check SIP Port:</strong>
</code>`<code>bash
<h1 id="ensure-sip-port-is-open">Ensure SIP port is open</h1>
<p>sudo ufw allow 5060/udp</p>
<p>sudo ufw status | grep 5060</p>

<h1 id="verify-pbx-is-listening">Verify PBX is listening</h1>
<p>sudo netstat -ulnp | grep 5060</p>
</code>`<code>

<strong>2. Verify Credentials:</strong>
</code>`<code>bash
<h1 id="check-configyml">Check config.yml</h1>
<p>grep -A 5 "extensions:" config.yml</p>

<h1 id="verify-extension-number-and-password-match-phone-settings">Verify extension number and password match phone settings</h1>
</code>`<code>

<strong>3. Check Phone SIP Server Settings:</strong>
<ul>
<li>Server address should be: PBX IP or hostname</li>
<li>Port: 5060</li>
<li>Transport: UDP (or TCP if configured)</li>
<li>Extension: matches config.yml</li>
<li>Password: matches config.yml</li>
</ul>

<strong>4. View Registration Logs:</strong>
</code>`<code>bash
<h1 id="monitor-sip-registration-attempts">Monitor SIP registration attempts</h1>
<p>tail -f logs/pbx.log | grep REGISTER</p>

<h1 id="should-see-successful-200-ok-responses">Should see successful 200 OK responses</h1>
</code>`<code>

<strong>5. Test Connectivity:</strong>
</code>`<code>bash
<h1 id="from-phone-network-test-sip-port">From phone network, test SIP port</h1>
<p>nc -u -v PBX_IP 5060</p>

<h1 id="check-if-pbx-is-reachable">Check if PBX is reachable</h1>
<p>ping PBX_IP</p>
</code>`<code>

<strong>6. Check for Registration Conflicts:</strong>
</code>`<code>bash
<h1 id="verify-no-duplicate-extensions">Verify no duplicate extensions</h1>
<p>grep "number:" config.yml | sort | uniq -d</p>

<h1 id="clear-any-stale-registrations">Clear any stale registrations</h1>
<p>curl -k https://localhost:9000/api/extensions</p>
</code>`<code>

<h3 id="intermittent-registration-drops">Intermittent Registration Drops</h3>

<strong>Symptoms:</strong>
<ul>
<li>Phones register then unregister randomly</li>
<li>Periodic registration failures</li>
</ul>

<strong>Solutions:</strong>

<strong>1. Check Registration Timeout:</strong>
</code>`<code>yaml
<h1 id="configyml">config.yml</h1>
<p>sip:</p>
<p>  registration_timeout: 3600  # Increase if too low</p>
</code>`<code>

<strong>2. Enable NAT Keepalive:</strong>
<ul>
<li>Configure phones to send keepalive packets</li>
<li>Typical interval: 30-60 seconds</li>
</ul>

<strong>3. Check Network Stability:</strong>
</code>`<code>bash
<h1 id="monitor-for-network-drops">Monitor for network drops</h1>
<p>ping -c 100 PHONE_IP</p>

<h1 id="check-for-packet-loss">Check for packet loss</h1>
</code>`<code>

<strong>4. Review Firewall Timeout Settings:</strong>
</code>`<code>bash
<h1 id="ensure-firewall-doesnt-drop-long-lived-udp-connections">Ensure firewall doesn't drop long-lived UDP connections</h1>
<h1 id="may-need-to-adjust-connection-tracking-timeout">May need to adjust connection tracking timeout</h1>
</code>`<code>

<hr>

<h2 id="admin-panel-issues">Admin Panel Issues</h2>

<h3 id="login-connection-errors">Login Connection Errors</h3>

<strong>Symptoms:</strong>
<ul>
<li>"Connection error. Please try again." message</li>
<li>Cannot access admin panel</li>
<li>Login page loads but authentication fails</li>
</ul>

<strong>Diagnostic Steps:</strong>

<strong>1. Check PBX Service Status:</strong>
</code>`<code>bash
<p>sudo systemctl status pbx</p>

<h1 id="if-not-running">If not running:</h1>
<p>sudo systemctl start pbx</p>

<h1 id="check-for-errors">Check for errors:</h1>
<p>sudo journalctl -u pbx -n 50</p>
</code>`<code>

<strong>2. Verify API Accessibility:</strong>
</code>`<code>bash
<h1 id="test-api-endpoint">Test API endpoint</h1>
<p>curl -k https://localhost:9000/api/status</p>

<h1 id="should-return-json-with-status-information">Should return JSON with status information</h1>
</code>`<code>

<strong>3. Check Browser Console:</strong>
<ul>
<li>Press F12 to open developer tools</li>
<li>Look at Console tab for JavaScript errors</li>
<li>Check Network tab for failed requests</li>
<li>Note: Red CORS errors or 502/504 errors indicate connectivity issues</li>
</ul>

<strong>4. Verify Firewall:</strong>
</code>`<code>bash
<p>sudo ufw status | grep 9000</p>

<h1 id="if-not-allowed">If not allowed:</h1>
<p>sudo ufw allow 9000/tcp</p>
</code>`<code>

<strong>5. Check Port Binding:</strong>
</code>`<code>bash
<h1 id="verify-pbx-is-listening-on-correct-port">Verify PBX is listening on correct port</h1>
<p>sudo netstat -tlnp | grep 9000</p>

<h1 id="should-show-pythonpbx-process">Should show python/pbx process</h1>
</code>`<code>

<strong>6. Test from Different Network:</strong>
<ul>
<li>Try accessing from localhost</li>
<li>Try from same network</li>
<li>Try from external network (if applicable)</li>
</ul>

<strong>7. Check Reverse Proxy (if used):</strong>
</code>`<code>bash
<h1 id="if-using-nginx">If using nginx</h1>
<p>sudo systemctl status nginx</p>
<p>sudo nginx -t</p>

<h1 id="check-nginx-logs">Check nginx logs</h1>
<p>sudo tail -f /var/log/nginx/error.log</p>
</code>`<code>

<h3 id="err_ssl_protocol_error-with-reverse-proxy">ERR_SSL_PROTOCOL_ERROR with Reverse Proxy</h3>

<strong>Status:</strong> ✅ <strong>DOCUMENTED</strong> (December 30, 2025)

<strong>Symptoms:</strong>
<ul>
<li>Browser shows "This site can't provide a secure connection"</li>
<li>ERR_SSL_PROTOCOL_ERROR message</li>
<li>"sent an invalid response" error</li>
<li>"Proxy Error: Error reading from remote server"</li>
<li>Occurs after enabling SSL on admin UI with Apache/Nginx</li>
</ul>

<strong>Root Cause:</strong>
<p>Backend API configured with SSL enabled (</code>api.ssl.enabled: true<code>) when it should be HTTP-only behind a reverse proxy. Apache/Nginx expects to proxy HTTPS → HTTP, but finds HTTPS → HTTPS causing SSL protocol mismatch.</p>

<strong>Architecture Overview:</strong>

<p>✅ <strong>Correct Setup:</strong></p>
</code>`<code>
<p>Browser ──HTTPS──> Apache (port 443) ──HTTP──> PBX Backend (port 9000)</p>
<p>         SSL/TLS    ↑ SSL Termination      ↑ Plain HTTP (internal)</p>
</code>`<code>

<p>❌ <strong>Incorrect Setup (Causes Error):</strong></p>
</code>`<code>
<p>Browser ──HTTPS──> Apache (port 443) ──HTTPS──> PBX Backend (port 9000)</p>
<p>         SSL/TLS                         SSL/TLS (conflict!)</p>
</code>`<code>

<strong>Quick Fix:</strong>
</code>`<code>bash
<h1 id="1-edit-configuration">1. Edit configuration</h1>
<p>nano config.yml</p>

<h1 id="2-find-apissl-section-and-set">2. Find api.ssl section and set:</h1>
<p>api:</p>
<p>  ssl:</p>
<p>    enabled: false  # ← Must be false for reverse proxy</p>

<h1 id="3-restart-service">3. Restart service</h1>
<p>sudo systemctl restart pbx</p>

<h1 id="4-verify-backend-is-http">4. Verify backend is HTTP</h1>
<p>curl http://localhost:9000/api/health  # Should work</p>
<p>curl https://localhost:9000/api/health  # Should fail</p>
</code>`<code>

<strong>Detailed Verification Steps:</strong>

<strong>1. Check Current Configuration:</strong>
</code>`<code>bash
<p>cd /path/to/PBX</p>
<p>grep -A 5 "api:" config.yml | grep -A 2 "ssl:"</p>
</code>`<code>

<p>Expected output for reverse proxy:</p>
</code>`<code>yaml
<p>ssl:</p>
<p>  enabled: false  # ← Should be FALSE</p>
</code>`<code>

<strong>2. Verify Backend HTTP Only:</strong>
</code>`<code>bash
<h1 id="should-return-json-health-status">Should return JSON health status</h1>
<p>curl http://localhost:9000/api/health</p>

<h1 id="should-fail-connection-refused-or-certificate-error">Should fail (connection refused or certificate error)</h1>
<p>curl https://localhost:9000/api/health</p>
</code>`<code>

<strong>3. Test Apache/Nginx Proxy:</strong>
</code>`<code>bash
<h1 id="should-return-json-status-through-proxy">Should return JSON status through proxy</h1>
<p>curl https://yourdomain.com/api/health</p>
</code>`<code>

<strong>4. Check Listening Ports:</strong>
</code>`<code>bash
<h1 id="pbx-should-listen-on-9000-http-not-ssl">PBX should listen on 9000 (HTTP, not SSL)</h1>
<p>sudo netstat -tlnp | grep 9000</p>

<h1 id="apache-should-listen-on-443-ssl">Apache should listen on 443 (SSL)</h1>
<p>sudo netstat -tlnp | grep 443</p>
</code>`<code>

<strong>Common Mistakes:</strong>
<ul>
<li>Enabling </code>api.ssl.enabled: true<code> when using reverse proxy</li>
<li>Apache/Nginx proxy pointing to </code>https://localhost:9000<code> instead of </code>http://localhost:9000<code></li>
<li>Firewall blocking internal HTTP communication</li>
<li>Wrong port in Apache/Nginx config</li>
</ul>

<strong>When to Use Direct SSL:</strong>
<p>Only enable </code>api.ssl.enabled: true<code> when:</p>
<ul>
<li>NOT using Apache/Nginx reverse proxy</li>
<li>Accessing PBX directly (e.g., </code>https://192.168.1.14:9000/admin/<code>)</li>
<li>Development/testing environment</li>
<li>Self-signed certificates are acceptable</li>
</ul>

<strong>Note:</strong> For production, always use reverse proxy with SSL termination.

<h3 id="admin-panel-display-issues-broken-ui">Admin Panel Display Issues (Broken UI)</h3>

<strong>Status:</strong> ✅ <strong>FIXED</strong> (December 23, 2025)

<strong>Symptoms:</strong>
<ul>
<li>Admin panel displays incorrectly after updates</li>
<li>Buttons not clickable</li>
<li>Styles missing or broken</li>
<li>Only login component works</li>
</ul>

<strong>Root Cause:</strong>
<p>Browser caching old CSS/JavaScript files after server code updates.</p>

<strong>Immediate Fix:</strong>
</code>`<code>
<p>Press Ctrl+Shift+R (Windows/Linux) or Cmd+Shift+R (Mac) for hard refresh</p>
</code>`<code>

<strong>Permanent Prevention:</strong>
<ul>
<li>Cache-control meta tags added to HTML files</li>
<li>Version query parameters added to CSS/JS includes</li>
<li>Automatic detection with warning banner</li>
</ul>

<strong>Diagnostic Page:</strong>
</code>`<code>
<p>Visit: https://localhost:9000/admin/status-check.html</p>
</code>`<code>

<p>This page will:</p>
<ul>
<li>Test API connectivity</li>
<li>Verify JavaScript loading</li>
<li>Check for cache issues</li>
<li>Display system status</li>
</ul>

<strong>Manual Cache Clear:</strong>
</code>`<code>
<ol>
<li>Chrome: Settings → Privacy → Clear browsing data → Cached images and files</li>
<li>Firefox: Options → Privacy → Clear Data → Cached Web Content</li>
<li>Edge: Settings → Privacy → Choose what to clear → Cached data</li>
</ol>
</code>`<code>

<h3 id="cannot-access-admin-panel-after-installation">Cannot Access Admin Panel After Installation</h3>

<strong>Symptoms:</strong>
<ul>
<li>Fresh installation, admin panel not accessible</li>
<li>404 or connection refused errors</li>
</ul>

<strong>Solutions:</strong>

<strong>1. Verify Installation Completed:</strong>
</code>`<code>bash
<h1 id="check-if-all-files-are-present">Check if all files are present</h1>
<p>ls -la admin/</p>

<h1 id="should-contain-indexhtml-loginhtml-css-js">Should contain: index.html, login.html, css/, js/</h1>
</code>`<code>

<strong>2. Check Service Started:</strong>
</code>`<code>bash
<p>sudo systemctl status pbx</p>
<p>sudo systemctl enable pbx  # Enable auto-start</p>
<p>sudo systemctl start pbx</p>
</code>`<code>

<strong>3. Wait for Initialization:</strong>
</code>`<code>bash
<h1 id="pbx-may-take-30-60-seconds-to-fully-start">PBX may take 30-60 seconds to fully start</h1>
<h1 id="watch-logs">Watch logs:</h1>
<p>sudo journalctl -u pbx -f</p>
</code>`<code>

<strong>4. Verify SSL Certificate:</strong>
</code>`<code>bash
<h1 id="check-certificate-exists">Check certificate exists</h1>
<p>ls -la certs/</p>

<h1 id="regenerate-if-needed">Regenerate if needed</h1>
<p>python scripts/generate_ssl_cert.py --hostname YOUR_IP</p>
</code>`<code>

<h3 id="apache-not-found-error-for-admin-pages">Apache "Not Found" Error for Admin Pages</h3>

<strong>Symptoms:</strong>
<ul>
<li>Accessing admin pages returns: "Not Found - The requested URL was not found on this server."</li>
<li>Error message shows "Apache/2.4.58 (Ubuntu)" or similar</li>
<li>Direct access to PBX port works (e.g., http://localhost:9000/admin/)</li>
</ul>

<strong>Root Cause:</strong>
<p>Apache is serving requests directly without proxying to the PBX application. The admin files need to be accessed through a reverse proxy configuration.</p>

<strong>Quick Fix:</strong>

<strong>Option 1: Automated Setup (Recommended)</strong>
</code>`<code>bash
<p>cd /path/to/PBX</p>
<p>sudo scripts/setup_apache_reverse_proxy.sh</p>
</code>`<code>

<strong>Option 2: Manual Configuration</strong>
</code>`<code>bash
<h1 id="enable-required-modules">Enable required modules</h1>
<p>sudo a2enmod proxy proxy_http proxy_wstunnel headers rewrite ssl</p>

<h1 id="create-virtual-host-configuration">Create virtual host configuration</h1>
<p>sudo nano /etc/apache2/sites-available/pbx.conf</p>
</code>`<code>

<p>Add minimal configuration:</p>
</code>`<code>apache
<VirtualHost *:80>
<p>    ServerName your-domain.com</p>
    
<p>    ProxyPreserveHost On</p>
<p>    ProxyRequests Off</p>
    
    <Location />
<p>        ProxyPass http://localhost:9000/</p>
<p>        ProxyPassReverse http://localhost:9000/</p>
    </Location>
    
<p>    ErrorLog ${APACHE_LOG_DIR}/pbx-error.log</p>
<p>    CustomLog ${APACHE_LOG_DIR}/pbx-access.log combined</p>
</VirtualHost>
</code>`<code>

<p>Enable site and restart:</p>
</code>`<code>bash
<p>sudo a2ensite pbx.conf</p>
<p>sudo apache2ctl configtest</p>
<p>sudo systemctl restart apache2</p>
</code>`<code>

<strong>Detailed Documentation:</strong>
<ul>
<li>Quick fix guide: </code>docs/APACHE_404_FIX.md<code></li>
<li>Complete setup: </code>docs/APACHE_REVERSE_PROXY_SETUP.md<code></li>
<li>Configuration example: </code>apache-pbx.conf.example<code></li>
</ul>

<strong>Verification:</strong>
</code>`<code>bash
<h1 id="test-that-pages-now-load">Test that pages now load</h1>
<p>curl http://your-domain.com/admin/status-check.html</p>

<h1 id="should-return-html-content-not-404-error">Should return HTML content, not 404 error</h1>
</code>`<code>

<hr>

<h2 id="integration-problems">Integration Problems</h2>

<h3 id="email-notifications-not-sending">Email Notifications Not Sending</h3>

<strong>Symptoms:</strong>
<ul>
<li>Voicemail notifications not received</li>
<li>No emails from system</li>
<li>SMTP errors in logs</li>
</ul>

<strong>Solutions:</strong>

<strong>1. Test SMTP Configuration:</strong>
</code>`<code>bash
<h1 id="run-email-test-script">Run email test script</h1>
<p>python -c "import smtplib; s=smtplib.SMTP('localhost', 25); print(s.ehlo()); s.quit()"</p>

<h1 id="should-show-smtp-connection-and-send-test">Should show SMTP connection and send test</h1>
</code>`<code>

<strong>2. Verify SMTP Credentials:</strong>
</code>`<code>bash
<h1 id="check-env-file">Check .env file</h1>
<p>cat .env | grep SMTP</p>

<h1 id="required">Required:</h1>
<h1 id="smtp_host">SMTP_HOST</h1>
<h1 id="smtp_port">SMTP_PORT</h1>
<h1 id="smtp_username">SMTP_USERNAME</h1>
<h1 id="smtp_password">SMTP_PASSWORD</h1>
</code>`<code>

<strong>3. Check Email Configuration:</strong>
</code>`<code>yaml
<h1 id="configyml">config.yml</h1>
<p>voicemail:</p>
<p>  email_notifications: true</p>
<p>  smtp:</p>
<p>    host: "smtp.gmail.com"</p>
<p>    port: 587</p>
<p>    use_tls: true</p>
<p>    username: "${SMTP_USERNAME}"</p>
<p>    password: "${SMTP_PASSWORD}"</p>
</code>`<code>

<strong>4. Gmail-Specific Issues:</strong>
</code>`<code>bash
<h1 id="for-gmail-use-app-password-not-regular-password">For Gmail, use App Password (not regular password)</h1>
<h1 id="enable-2fa-on-google-account">Enable 2FA on Google account</h1>
<h1 id="generate-app-password-httpsmyaccountgooglecomapppasswords">Generate app password: https://myaccount.google.com/apppasswords</h1>
<h1 id="use-app-password-in-env">Use app password in .env</h1>
</code>`<code>

<strong>5. Office 365 Issues:</strong>
</code>`<code>yaml
<p>smtp:</p>
<p>  host: "smtp.office365.com"</p>
<p>  port: 587</p>
<p>  use_tls: true</p>
</code>`<code>

<strong>6. Check Logs:</strong>
</code>`<code>bash
<p>tail -f logs/pbx.log | grep -i email</p>

<h1 id="look-for-smtp-connection-errors">Look for SMTP connection errors</h1>
</code>`<code>

<strong>7. Test Email Server Connectivity:</strong>
</code>`<code>bash
<h1 id="test-smtp-server-reachable">Test SMTP server reachable</h1>
<p>telnet smtp.gmail.com 587</p>

<h1 id="should-connect-successfully">Should connect successfully</h1>
</code>`<code>

<strong>8. Verify Email in Extension Config:</strong>
</code>`<code>yaml
<p>extensions:</p>
<ul>
<li>number: "1001"</li>
</ul>
<p>    email: "user@company.com"  # Must be set</p>
</code>`<code>

<h3 id="active-directory-integration-not-working">Active Directory Integration Not Working</h3>

<strong>Symptoms:</strong>
<ul>
<li>AD sync fails</li>
<li>Cannot search AD users</li>
<li>Authentication errors</li>
</ul>

<strong>Solutions:</strong>

<strong>1. Test AD Connectivity:</strong>
</code>`<code>bash
<h1 id="test-ldap-connection">Test LDAP connection</h1>
<p>ldapsearch -x -H ldap://ad.company.com -D "CN=pbx-service,DC=company,DC=com" -W -b "DC=company,DC=com"</p>
</code>`<code>

<strong>2. Verify AD Configuration:</strong>
</code>`<code>yaml
<p>integrations:</p>
<p>  active_directory:</p>
<p>    enabled: true</p>
<p>    server: "ldap://ad.company.com"</p>
<p>    port: 389</p>
<p>    bind_dn: "CN=pbx-service,DC=company,DC=com"</p>
<p>    bind_password: "${AD_PASSWORD}"</p>
<p>    base_dn: "DC=company,DC=com"</p>
</code>`<code>

<strong>3. Check AD Credentials:</strong>
</code>`<code>bash
<h1 id="verify-env-has-ad-password">Verify .env has AD password</h1>
<p>cat .env | grep AD_PASSWORD</p>

<h1 id="test-credentials-directly">Test credentials directly</h1>
</code>`<code>

<strong>4. Enable LDAPS (if using SSL):</strong>
</code>`<code>yaml
<p>active_directory:</p>
<p>  server: "ldaps://ad.company.com"</p>
<p>  port: 636</p>
<p>  use_ssl: true</p>
</code>`<code>

<strong>5. Check Firewall:</strong>
</code>`<code>bash
<h1 id="ldap-port">LDAP port</h1>
<p>sudo ufw allow 389/tcp</p>

<h1 id="ldaps-port-if-ssl">LDAPS port (if SSL)</h1>
<p>sudo ufw allow 636/tcp</p>
</code>`<code>

<strong>6. View Integration Logs:</strong>
</code>`<code>bash
<p>tail -f logs/pbx.log | grep -i "AD\|LDAP"</p>
</code>`<code>

<h3 id="webhook-delivery-failures">Webhook Delivery Failures</h3>

<strong>Symptoms:</strong>
<ul>
<li>Webhooks not triggering</li>
<li>Events not sent to external systems</li>
<li>Webhook errors in logs</li>
</ul>

<strong>Solutions:</strong>

<strong>1. Verify Webhook Configuration:</strong>
</code>`<code>yaml
<p>webhooks:</p>
<p>  enabled: true</p>
<p>  subscriptions:</p>
<ul>
<li>url: "https://crm.company.com/api/pbx/events"</li>
</ul>
<p>      events: ["call.answered", "call.ended"]</p>
<p>      secret: "${WEBHOOK_SECRET}"</p>
</code>`<code>

<strong>2. Test Webhook Endpoint:</strong>
</code>`<code>bash
<h1 id="test-destination-is-reachable">Test destination is reachable</h1>
<p>curl -v https://crm.company.com/api/pbx/events</p>
</code>`<code>

<strong>3. Check Webhook Logs:</strong>
</code>`<code>bash
<p>tail -f logs/pbx.log | grep -i webhook</p>

<h1 id="look-for-delivery-attempts-and-errors">Look for delivery attempts and errors</h1>
</code>`<code>

<strong>4. Verify HMAC Signature:</strong>
<ul>
<li>Ensure receiving system validates signature correctly</li>
<li>Check secret matches in both systems</li>
</ul>

<strong>5. Check Retry Configuration:</strong>
</code>`<code>yaml
<p>webhooks:</p>
<p>  retry:</p>
<p>    max_attempts: 3</p>
<p>    backoff_factor: 2</p>
</code>`<code>

<hr>

<h2 id="phone-provisioning">Phone Provisioning</h2>

<h3 id="phones-wont-auto-provision">Phones Won't Auto-Provision</h3>

<strong>Symptoms:</strong>
<ul>
<li>Phone doesn't download configuration</li>
<li>Manual configuration works but auto-provision fails</li>
<li>Phone shows "Provisioning failed" or similar</li>
</ul>

<strong>Solutions:</strong>

<strong>1. Verify Provisioning Server Running:</strong>
</code>`<code>bash
<h1 id="check-provisioning-port">Check provisioning port</h1>
<p>sudo netstat -tlnp | grep 8888</p>

<h1 id="should-show-pythonpbx-listening-on-8888">Should show python/pbx listening on 8888</h1>
</code>`<code>

<strong>2. Check DHCP Option 66:</strong>
</code>`<code>bash
<h1 id="option-66-should-point-to-httppbx_ip8888">Option 66 should point to: http://PBX_IP:8888</h1>

<h1 id="test-from-phone-network">Test from phone network:</h1>
<p>curl http://PBX_IP:8888/</p>
</code>`<code>

<strong>3. Manual Phone Configuration:</strong>
<p>If DHCP Option 66 not available:</p>
<ul>
<li>Access phone web interface</li>
<li>Set provision server: </code>http://PBX_IP:8888<code></li>
<li>Trigger reprovisioning</li>
</ul>

<strong>4. Verify Template Exists:</strong>
</code>`<code>bash
<h1 id="check-templates-directory">Check templates directory</h1>
<p>ls -la provisioning_templates/</p>

<h1 id="should-have-templates-for-your-phone-brand">Should have templates for your phone brand</h1>
</code>`<code>

<strong>5. Check Phone MAC Address:</strong>
</code>`<code>bash
<h1 id="template-filename-often-uses-mac-address">Template filename often uses MAC address</h1>
<h1 id="eg-00-15-65-12-34-56cfg">e.g., 00-15-65-12-34-56.cfg</h1>

<h1 id="verify-mac-matches-phones-actual-mac">Verify MAC matches phone's actual MAC</h1>
</code>`<code>

<strong>6. Check File Permissions:</strong>
</code>`<code>bash
<p>sudo chown -R pbx:pbx provisioning_templates/</p>
<p>sudo chmod 644 provisioning_templates/*.cfg</p>
</code>`<code>

<strong>7. View Provisioning Logs:</strong>
</code>`<code>bash
<p>tail -f logs/pbx.log | grep -i provision</p>

<h1 id="should-show-http-requests-from-phones">Should show HTTP requests from phones</h1>
</code>`<code>

<strong>8. Test Template Generation:</strong>
</code>`<code>bash
<h1 id="view-generated-config-for-extension">View generated config for extension</h1>
<p>curl http://localhost:8888/provision/1001</p>

<h1 id="should-return-phone-configuration">Should return phone configuration</h1>
</code>`<code>

<h3 id="wrong-configuration-downloaded">Wrong Configuration Downloaded</h3>

<strong>Symptoms:</strong>
<ul>
<li>Phone provisions but with wrong settings</li>
<li>Extension number incorrect</li>
<li>Server settings wrong</li>
</ul>

<strong>Solutions:</strong>

<strong>1. Check Template Variables:</strong>
</code>`<code>bash
<h1 id="view-template">View template</h1>
<p>cat provisioning_templates/yealink_t46s.template</p>

<h1 id="verify-variables-are-correct">Verify variables are correct:</h1>
<h1 id="extension-password-sip_server-etc">{EXTENSION}, {PASSWORD}, {SIP_SERVER}, etc.</h1>
</code>`<code>

<strong>2. Verify Extension Exists:</strong>
</code>`<code>bash
<h1 id="check-extension-in-config">Check extension in config</h1>
<p>grep -A 5 "number: \"1001\"" config.yml</p>
</code>`<code>

<strong>3. Clear Phone's Config:</strong>
<ul>
<li>Factory reset phone</li>
<li>Reprovision from scratch</li>
</ul>

<strong>4. Manual Template Test:</strong>
</code>`<code>bash
<h1 id="test-template-rendering">Test template rendering</h1>
<p>curl http://localhost:8888/provision/1001?debug=true</p>

<h1 id="should-show-populated-template">Should show populated template</h1>
</code>`<code>

<h3 id="phone-specific-provisioning-issues">Phone-Specific Provisioning Issues</h3>

<strong>Yealink:</strong>
</code>`<code>bash
<h1 id="ensure-mac-address-format-001565-aabbcccfg">Ensure MAC address format: 001565-AABBCC.cfg</h1>
<h1 id="server-url-httppbx_ip8888maccfg">Server URL: http://PBX_IP:8888/$mac.cfg</h1>
</code>`<code>

<strong>Polycom:</strong>
</code>`<code>bash
<h1 id="boot-file-000000000000cfg-mac-address">Boot file: 000000000000.cfg (MAC address)</h1>
<h1 id="needs-both-application-and-configuration-files">Needs both application and configuration files</h1>
</code>`<code>

<strong>Cisco:</strong>
</code>`<code>bash
<h1 id="xml-based-configuration">XML-based configuration</h1>
<h1 id="separate-file-per-line-sepxxxxxxxxxxxxxcnfxml">Separate file per line: SEPXXXXXXXXXXXXX.cnf.xml</h1>
</code>`<code>

<strong>Grandstream:</strong>
</code>`<code>bash
<h1 id="cfg-cfgmac-format">cfg + cfgMAC format</h1>
<h1 id="http-provisioning-on-port-8888">HTTP provisioning on port 8888</h1>
</code>`<code>

<hr>

<h2 id="database-issues">Database Issues</h2>

<h3 id="database-connection-errors">Database Connection Errors</h3>

<strong>Symptoms:</strong>
<ul>
<li>"Cannot connect to database" errors</li>
<li>Voicemail fails to save</li>
<li>CDR not logging</li>
</ul>

<strong>Solutions:</strong>

<strong>1. Verify Database Running:</strong>
</code>`<code>bash
<h1 id="postgresql">PostgreSQL</h1>
<p>sudo systemctl status postgresql</p>
<p>sudo systemctl start postgresql</p>

<h1 id="check-connection">Check connection</h1>
<p>psql -U pbx_user -d pbx_system -h localhost</p>
</code>`<code>

<strong>2. Test Database Connection:</strong>
</code>`<code>bash
<p>python scripts/verify_database.py</p>

<h1 id="should-show-successful-connection">Should show successful connection</h1>
</code>`<code>

<strong>3. Check Database Credentials:</strong>
</code>`<code>bash
<h1 id="verify-env">Verify .env</h1>
<p>cat .env | grep DB_</p>

<h1 id="required">Required:</h1>
<h1 id="db_hostlocalhost">DB_HOST=localhost</h1>
<h1 id="db_port5432">DB_PORT=5432</h1>
<h1 id="db_namepbx_system">DB_NAME=pbx_system</h1>
<h1 id="db_userpbx_user">DB_USER=pbx_user</h1>
<h1 id="db_passwordyour_password">DB_PASSWORD=your_password</h1>
</code>`<code>

<strong>4. Verify Database Exists:</strong>
</code>`<code>bash
<p>sudo -u postgres psql -l | grep pbx_system</p>

<h1 id="if-not-exists-create">If not exists, create:</h1>
<p>sudo -u postgres createdb pbx_system</p>
</code>`<code>

<strong>5. Check User Permissions:</strong>
</code>`<code>bash
<p>sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE pbx_system TO pbx_user;"</p>
</code>`<code>

<strong>6. Initialize Database:</strong>
</code>`<code>bash
<h1 id="run-initialization-script">Run initialization script</h1>
<p>python scripts/init_database.py</p>

<h1 id="should-create-tables">Should create tables</h1>
</code>`<code>

<strong>7. Check Logs:</strong>
</code>`<code>bash
<p>tail -f logs/pbx.log | grep -i database</p>

<h1 id="look-for-connection-errors">Look for connection errors</h1>
</code>`<code>

<h3 id="database-migration-errors">Database Migration Errors</h3>

<strong>Symptoms:</strong>
<ul>
<li>Errors after upgrading PBX version</li>
<li>Schema mismatch errors</li>
<li>Missing table errors</li>
</ul>

<strong>Solutions:</strong>

<strong>1. Backup Database:</strong>
</code>`<code>bash
<p>sudo -u postgres pg_dump pbx_system > /backup/pbx_backup.sql</p>
</code>`<code>

<strong>2. Run Migration:</strong>
</code>`<code>bash
<p>alembic upgrade head</p>

<h1 id="follow-prompts">Applies all pending migrations</h1>
</code>`<code>

<strong>3. Check Schema Version:</strong>
</code>`<code>bash
<p>sudo -u postgres psql pbx_system -c "SELECT * FROM schema_version;"</p>
</code>`<code>

<strong>4. Manual Table Creation:</strong>
</code>`<code>bash
<h1 id="if-specific-table-missing">If specific table missing</h1>
<p>alembic upgrade head</p>
</code>`<code>

<h3 id="voicemail-database-issues">Voicemail Database Issues</h3>

<strong>Symptoms:</strong>
<ul>
<li>Voicemails not saved</li>
<li>Cannot retrieve messages</li>
<li>Database errors in voicemail logs</li>
</ul>

<strong>Solutions:</strong>

<strong>1. Initialize Voicemail Tables:</strong>
</code>`<code>bash
<p>python scripts/init_database.py</p>

<h1 id="creates-voicemail_messages-table">Creates voicemail_messages table</h1>
</code>`<code>

<strong>2. Verify Tables Exist:</strong>
</code>`<code>bash
<p>sudo -u postgres psql pbx_system -c "\dt"</p>

<h1 id="should-show-voicemail_messages-table">Should show voicemail_messages table</h1>
</code>`<code>

<strong>3. Check File Storage:</strong>
</code>`<code>bash
<h1 id="verify-voicemail-directory-exists">Verify voicemail directory exists</h1>
<p>ls -la voicemail/</p>

<h1 id="create-if-missing">Create if missing</h1>
<p>mkdir -p voicemail/1001</p>
<p>sudo chown -R pbx:pbx voicemail/</p>
</code>`<code>

<strong>4. Test Voicemail Save:</strong>
</code>`<code>bash
<h1 id="make-test-call-to-voicemail">Make test call to voicemail</h1>
<h1 id="check-if-file-created-in-voicemailextension">Check if file created in voicemail/EXTENSION/</h1>
</code>`<code>

<hr>

<h2 id="service-management">Service Management</h2>

<h3 id="pbx-service-wont-start">PBX Service Won't Start</h3>

<strong>Symptoms:</strong>
<ul>
<li></code>systemctl start pbx<code> fails</li>
<li>Service shows "failed" or "inactive"</li>
<li>Immediate exit after start</li>
</ul>

<strong>Solutions:</strong>

<strong>1. Check Service Status:</strong>
</code>`<code>bash
<p>sudo systemctl status pbx</p>

<h1 id="look-for-exit-code-and-error-message">Look for exit code and error message</h1>
</code>`<code>

<strong>2. View Detailed Logs:</strong>
</code>`<code>bash
<p>sudo journalctl -u pbx -n 100 --no-pager</p>

<h1 id="look-for-python-errors-or-traceback">Look for Python errors or traceback</h1>
</code>`<code>

<strong>3. Check Configuration File:</strong>
</code>`<code>bash
<h1 id="validate-yaml-syntax">Validate YAML syntax</h1>
<p>python -c "import yaml; yaml.safe_load(open('config.yml'))"</p>

<h1 id="should-complete-without-errors">Should complete without errors</h1>
</code>`<code>

<strong>4. Verify Python Dependencies:</strong>
</code>`<code>bash
<p>pip list | grep -i twisted</p>
<p>pip list | grep -i yaml</p>

<h1 id="reinstall-if-missing">Reinstall if missing</h1>
<p>pip install -r requirements.txt</p>
</code>`<code>

<strong>5. Check File Permissions:</strong>
</code>`<code>bash
<p>sudo chown -R pbx:pbx /opt/pbx/</p>
<p>sudo chmod 755 /opt/pbx/main.py</p>
</code>`<code>

<strong>6. Test Manual Start:</strong>
</code>`<code>bash
<h1 id="run-manually-to-see-errors">Run manually to see errors</h1>
<p>cd /opt/pbx</p>
<p>python main.py</p>

<h1 id="should-show-startup-messages-or-errors">Should show startup messages or errors</h1>
</code>`<code>

<strong>7. Check Port Conflicts:</strong>
</code>`<code>bash
<h1 id="verify-ports-not-in-use">Verify ports not in use</h1>
<p>sudo netstat -tlnp | grep -E "(5060|9000)"</p>

<h1 id="if-in-use-kill-conflicting-process-or-change-pbx-ports">If in use, kill conflicting process or change PBX ports</h1>
</code>`<code>

<h3 id="service-crashes-or-restarts-frequently">Service Crashes or Restarts Frequently</h3>

<strong>Symptoms:</strong>
<ul>
<li>Service keeps restarting</li>
<li>Unexpected exits</li>
<li>Crashes under load</li>
</ul>

<strong>Solutions:</strong>

<strong>1. Check Crash Logs:</strong>
</code>`<code>bash
<p>sudo journalctl -u pbx -f</p>

<h1 id="watch-for-crash-patterns">Watch for crash patterns</h1>
</code>`<code>

<strong>2. Review Application Logs:</strong>
</code>`<code>bash
<p>tail -f logs/pbx.log</p>

<h1 id="look-for-exceptions-or-errors-before-crash">Look for exceptions or errors before crash</h1>
</code>`<code>

<strong>3. Check Memory Usage:</strong>
</code>`<code>bash
<p>free -h</p>
<p>top -p $(pgrep -f "python.*main.py")</p>

<h1 id="verify-sufficient-memory-available">Verify sufficient memory available</h1>
</code>`<code>

<strong>4. Check Disk Space:</strong>
</code>`<code>bash
<p>df -h</p>

<h1 id="ensure-varlog-and-application-directories-have-space">Ensure /var/log and application directories have space</h1>
</code>`<code>

<strong>5. Review Core Dumps:</strong>
</code>`<code>bash
<h1 id="check-for-core-dumps">Check for core dumps</h1>
<p>ls -la /var/crash/</p>
<p>ls -la core.*</p>

<h1 id="analyze-if-present">Analyze if present</h1>
</code>`<code>

<strong>6. Enable Debug Logging:</strong>
</code>`<code>yaml
<h1 id="configyml">config.yml</h1>
<p>logging:</p>
<p>  level: "DEBUG"</p>
</code>`<code>

<strong>7. Check SystemD Service Settings:</strong>
</code>`<code>bash
<h1 id="view-service-file">View service file</h1>
<p>cat /etc/systemd/system/pbx.service</p>

<h1 id="check-restart-settings">Check Restart= settings</h1>
<h1 id="may-need-to-adjust-restart-policy">May need to adjust restart policy</h1>
</code>`<code>

<hr>

<h2 id="network-firewall">Network & Firewall</h2>

<h3 id="firewall-blocking-traffic">Firewall Blocking Traffic</h3>

<strong>Symptoms:</strong>
<ul>
<li>Connections timeout</li>
<li>Intermittent connectivity</li>
<li>Some features work, others don't</li>
</ul>

<strong>Solutions:</strong>

<strong>1. Check Firewall Status:</strong>
</code>`<code>bash
<p>sudo ufw status verbose</p>

<h1 id="should-show">Should show:</h1>
<h1 id="5060udp-allow-in">5060/udp ALLOW IN</h1>
<h1 id="9000tcp-allow-in">9000/tcp ALLOW IN</h1>
<h1 id="1000020000udp-allow-in">10000:20000/udp ALLOW IN</h1>
</code>`<code>

<strong>2. Open Required Ports:</strong>
</code>`<code>bash
<h1 id="sip-signaling">SIP signaling</h1>
<p>sudo ufw allow 5060/udp</p>

<h1 id="adminapi">Admin/API</h1>
<p>sudo ufw allow 9000/tcp</p>
<p>sudo ufw allow 443/tcp</p>

<h1 id="rtp-media">RTP media</h1>
<p>sudo ufw allow 10000:20000/udp</p>

<h1 id="reload-firewall">Reload firewall</h1>
<p>sudo ufw reload</p>
</code>`<code>

<strong>3. Check IPTables (if using):</strong>
</code>`<code>bash
<p>sudo iptables -L -n -v | grep -E "(5060|9000|10000)"</p>
</code>`<code>

<strong>4. Test Connectivity:</strong>
</code>`<code>bash
<h1 id="from-external-host">From external host</h1>
<p>nc -u -v PBX_IP 5060  # SIP</p>
<p>nc -v PBX_IP 9000     # HTTPS</p>

<h1 id="should-connect">Should connect</h1>
</code>`<code>

<strong>5. Disable Firewall Temporarily (Testing Only):</strong>
</code>`<code>bash
<p>sudo ufw disable</p>

<h1 id="test-if-issue-resolves">Test if issue resolves</h1>
<h1 id="re-enable-sudo-ufw-enable">Re-enable: sudo ufw enable</h1>
</code>`<code>

<h3 id="natrouting-issues">NAT/Routing Issues</h3>

<strong>Symptoms:</strong>
<ul>
<li>Works internally but not externally</li>
<li>One-way audio across networks</li>
<li>Registration from remote phones fails</li>
</ul>

<strong>Solutions:</strong>

<strong>1. Configure External IP:</strong>
</code>`<code>yaml
<h1 id="configyml">config.yml</h1>
<p>server:</p>
<p>  external_ip: "YOUR_PUBLIC_IP"</p>
</code>`<code>

<strong>2. Enable STUN:</strong>
</code>`<code>yaml
<p>stun:</p>
<p>  enabled: true</p>
<p>  server: "stun.l.google.com:19302"</p>
</code>`<code>

<strong>3. Port Forwarding:</strong>
</code>`<code>bash
<h1 id="on-router-forward-these-ports-to-pbx">On router, forward these ports to PBX:</h1>
<h1 id="udp-5060-sip">UDP 5060 (SIP)</h1>
<h1 id="udp-10000-20000-rtp">UDP 10000-20000 (RTP)</h1>
<h1 id="tcp-9000-or-443-https">TCP 9000 or 443 (HTTPS)</h1>
</code>`<code>

<strong>4. Check NAT Type:</strong>
</code>`<code>bash
<h1 id="test-nat-behavior">Test NAT behavior</h1>
<h1 id="symmetric-nat-can-cause-issues">Symmetric NAT can cause issues</h1>
</code>`<code>

<strong>5. Configure SIP NAT Keepalive:</strong>
</code>`<code>yaml
<p>sip:</p>
<p>  nat_keepalive: true</p>
<p>  keepalive_interval: 30</p>
</code>`<code>

<hr>

<h2 id="configuration-issues">Configuration Issues</h2>

<h3 id="invalid-configuration-file">Invalid Configuration File</h3>

<strong>Symptoms:</strong>
<ul>
<li>PBX won't start</li>
<li>"YAML parse error" messages</li>
<li>Configuration not loading</li>
</ul>

<strong>Solutions:</strong>

<strong>1. Validate YAML Syntax:</strong>
</code>`<code>bash
<p>python -c "import yaml; yaml.safe_load(open('config.yml'))"</p>

<h1 id="will-show-line-number-of-syntax-error">Will show line number of syntax error</h1>
</code>`<code>

<strong>2. Common YAML Mistakes:</strong>
<ul>
<li>Tabs instead of spaces (use spaces only)</li>
<li>Incorrect indentation</li>
<li>Missing colons</li>
<li>Unquoted special characters</li>
</ul>

<strong>3. Check for Merge Conflicts:</strong>
</code>`<code>bash
<p>grep -n "<<<<<<" config.yml</p>
<p>grep -n ">>>>>>" config.yml</p>

<h1 id="if-found-resolve-conflicts-manually">If found, resolve conflicts manually</h1>
</code>`<code>

<strong>4. Use Example as Template:</strong>
</code>`<code>bash
<h1 id="compare-with-working-example">Compare with working example</h1>
<p>python -c "import yaml; yaml.safe_load(open('config.yml'))"</p>
</code>`<code>

<strong>5. Test Minimal Config:</strong>
</code>`<code>bash
<h1 id="start-with-minimal-configyml">Start with minimal config.yml</h1>
<h1 id="add-sections-incrementally-to-find-problem">Add sections incrementally to find problem</h1>
</code>`<code>

<h3 id="environment-variables-not-loading">Environment Variables Not Loading</h3>

<strong>Symptoms:</strong>
<ul>
<li>"${VAR}" appears in logs instead of value</li>
<li>Authentication fails</li>
<li>Missing credentials</li>
</ul>

<strong>Solutions:</strong>

<strong>1. Verify .env File:</strong>
</code>`<code>bash
<p>cat .env</p>

<h1 id="should-not-have-quotes-around-values">Should not have quotes around values:</h1>
<h1 id="db_passwordmypassword-">DB_PASSWORD=mypassword  ✓</h1>
<h1 id="db_passwordmypassword-quotes-will-be-included">DB_PASSWORD="mypassword"  ✗ (quotes will be included)</h1>
</code>`<code>

<strong>2. Check File Location:</strong>
</code>`<code>bash
<h1 id="env-must-be-in-same-directory-as-mainpy">.env must be in same directory as main.py</h1>
<p>ls -la .env</p>

<h1 id="or-set-env_file-path">Or set ENV_FILE path</h1>
<p>export ENV_FILE=/opt/pbx/.env</p>
</code>`<code>

<strong>3. Test Variable Loading:</strong>
</code>`<code>bash
<p>python -c "from dotenv import load_dotenv; import os; load_dotenv(); print(os.getenv('DB_PASSWORD'))"</p>

<h1 id="should-print-password-value">Should print password value</h1>
</code>`<code>

<strong>4. Check Permissions:</strong>
</code>`<code>bash
<p>sudo chmod 600 .env</p>
<p>sudo chown pbx:pbx .env</p>
</code>`<code>

<hr>

<h2 id="performance-monitoring">Performance & Monitoring</h2>

<h3 id="high-cpu-usage">High CPU Usage</h3>

<strong>Symptoms:</strong>
<ul>
<li>CPU constantly high</li>
<li>System sluggish</li>
<li>Calls affected</li>
</ul>

<strong>Solutions:</strong>

<strong>1. Check Active Calls:</strong>
</code>`<code>bash
<p>curl -k https://localhost:9000/api/calls | jq '.'</p>

<h1 id="high-call-volume-may-be-normal">High call volume may be normal</h1>
</code>`<code>

<strong>2. Review Process Stats:</strong>
</code>`<code>bash
<p>top -p $(pgrep -f "python.*main.py")</p>

<h1 id="check-cpu-percentage">Check CPU percentage</h1>
</code>`<code>

<strong>3. Check for Loops:</strong>
</code>`<code>bash
<h1 id="look-for-error-loops-in-logs">Look for error loops in logs</h1>
<p>tail -f logs/pbx.log | grep -i error</p>

<h1 id="may-indicate-infinite-retry-loop">May indicate infinite retry loop</h1>
</code>`<code>

<strong>4. Check Database Performance:</strong>
</code>`<code>bash
<h1 id="slow-queries-can-cause-cpu-spikes">Slow queries can cause CPU spikes</h1>
<p>sudo -u postgres psql pbx_system -c "SELECT * FROM pg_stat_activity;"</p>
</code>`<code>

<strong>5. Optimize Configuration:</strong>
</code>`<code>yaml
<h1 id="reduce-logging-level">Reduce logging level</h1>
<p>logging:</p>
<p>  level: "WARNING"</p>

<h1 id="disable-unnecessary-features">Disable unnecessary features</h1>
</code>`<code>

<h3 id="memory-leaks">Memory Leaks</h3>

<strong>Symptoms:</strong>
<ul>
<li>Memory usage grows over time</li>
<li>Eventually crashes or OOM</li>
<li>Performance degrades</li>
</ul>

<strong>Solutions:</strong>

<strong>1. Monitor Memory:</strong>
</code>`<code>bash
<h1 id="watch-memory-usage">Watch memory usage</h1>
<p>watch -n 5 'ps aux | grep python | grep main.py'</p>
</code>`<code>

<strong>2. Check Call Cleanup:</strong>
</code>`<code>bash
<h1 id="verify-calls-are-properly-ended">Verify calls are properly ended</h1>
<p>curl -k https://localhost:9000/api/calls</p>

<h1 id="stale-calls-indicate-cleanup-issue">Stale calls indicate cleanup issue</h1>
</code>`<code>

<strong>3. Restart Service Periodically:</strong>
</code>`<code>bash
<h1 id="temporary-workaround">Temporary workaround</h1>
<h1 id="add-cron-job-for-nightly-restart">Add cron job for nightly restart</h1>
<p>0 3 <em> </em> * systemctl restart pbx</p>
</code>`<code>

<strong>4. Enable Memory Profiling:</strong>
</code>`<code>python
<h1 id="add-to-mainpy-temporarily">Add to main.py temporarily</h1>
<p>import tracemalloc</p>
<p>tracemalloc.start()</p>
</code>`<code>

<h3 id="slow-performance">Slow Performance</h3>

<strong>Symptoms:</strong>
<ul>
<li>Delayed call setup</li>
<li>Slow API responses</li>
<li>UI lag</li>
</ul>

<strong>Solutions:</strong>

<strong>1. Check System Resources:</strong>
</code>`<code>bash
<h1 id="cpu">CPU</h1>
<p>top</p>

<h1 id="memory">Memory</h1>
<p>free -h</p>

<h1 id="disk-io">Disk I/O</h1>
<p>iostat</p>
</code>`<code>

<strong>2. Check Database Performance:</strong>
</code>`<code>bash
<h1 id="add-indexes-if-needed">Add indexes if needed</h1>
<p>sudo -u postgres psql pbx_system</p>

<h1 id="analyze-slow-queries">Analyze slow queries</h1>
<p>EXPLAIN ANALYZE SELECT * FROM voicemail_messages;</p>
</code>`<code>

<strong>3. Optimize Logging:</strong>
</code>`<code>yaml
<p>logging:</p>
<p>  level: "WARNING"  # Reduce from DEBUG</p>
</code>`<code>

<strong>4. Check Network Latency:</strong>
</code>`<code>bash
<p>ping -c 100 REMOTE_ENDPOINT</p>

<h1 id="high-latency-affects-performance">High latency affects performance</h1>
</code>`<code>

<hr>

<h2 id="historical-fixes-reference">Historical Fixes Reference</h2>

<p>This section documents significant bugs that have been fixed. Included for reference if similar issues appear.</p>

<h3 id="admin-panel-display-issues-browser-cache">Admin Panel Display Issues (Browser Cache)</h3>

<strong>Date Fixed:</strong> December 23, 2025  
<strong>Status:</strong> ✅ RESOLVED

<strong>Problem:</strong>
<p>After server updates, admin panel displayed incorrectly with non-functional buttons.</p>

<strong>Solution:</strong>
<ul>
<li>Added cache-control meta tags</li>
<li>Added version query parameters to CSS/JS</li>
<li>Created diagnostic page: /admin/status-check.html</li>
<li>Hard refresh: Ctrl+Shift+R</li>
</ul>

<strong>Files Modified:</strong>
<ul>
<li>admin/index.html</li>
<li>admin/login.html</li>
<li>admin/status-check.html</li>
</ul>

<h3 id="api-connection-timeout-reverse-proxy">API Connection Timeout (Reverse Proxy)</h3>

<strong>Date Fixed:</strong> December 23, 2025  
<strong>Status:</strong> ✅ RESOLVED

<strong>Problem:</strong>
<p>Admin panel API requests timing out through nginx reverse proxy.</p>

<strong>Solution:</strong>
<p>Added proxy timeouts to nginx configuration:</p>
</code>`<code>nginx
<p>proxy_connect_timeout 60s;</p>
<p>proxy_send_timeout 60s;</p>
<p>proxy_read_timeout 60s;</p>
</code>`<code>

<h3 id="audio-sample-rate-mismatch">Audio Sample Rate Mismatch</h3>

<strong>Date Fixed:</strong> December 19, 2025  
<strong>Status:</strong> ✅ RESOLVED

<strong>Problem:</strong>
<p>Voicemail prompts sounded distorted and garbled.</p>

<strong>Root Cause:</strong>
<p>Prompts generated at 16kHz but PCMU codec expects 8kHz.</p>

<strong>Solution:</strong>
<p>Regenerated all prompts at 8kHz sample rate.</p>

<strong>Verification:</strong>
</code>`<code>bash
<p>file voicemail_prompts/*.wav</p>
<h1 id="should-show-8000-hz">Should show: 8000 Hz</h1>
</code>`<code>

<h3 id="rtp-one-way-audio">RTP One-Way Audio</h3>

<strong>Date Fixed:</strong> December 2025  
<strong>Status:</strong> ✅ RESOLVED

<strong>Problem:</strong>
<p>RTP relay had race condition causing one-way or no audio.</p>

<strong>Root Cause:</strong>
<p>Relay required both endpoints before forwarding packets.</p>

<strong>Solution:</strong>
<p>Modified RTP relay to:</p>
<ul>
<li>Set caller endpoint immediately</li>
<li>Remove blocking condition</li>
<li>Forward packets as soon as first endpoint known</li>
</ul>

<h3 id="g722-codec-quantization">G.722 Codec Quantization</h3>

<strong>Date Fixed:</strong> December 2025  
<strong>Status:</strong> ✅ RESOLVED

<strong>Problem:</strong>
<p>G.722 audio severely distorted.</p>

<strong>Root Cause:</strong>
<p>MAX_QUANTIZATION_RANGE set to 256 instead of 32768.</p>

<strong>Solution:</strong>
</code>`<code>python
<h1 id="pbxfeaturesg722_codecpy">pbx/features/g722_codec.py</h1>
<p>MAX_QUANTIZATION_RANGE = 32768  # Corrected</p>
</code>`<code>

<hr>

<h2 id="additional-resources">Additional Resources</h2>

<h3 id="documentation">Documentation</h3>
<ul>
<li><a href="COMPLETE_GUIDE.md">COMPLETE_GUIDE.md</a> - Comprehensive PBX guide</li>
<li><a href="README.md">README.md</a> - Project overview</li>
<li><a href="docs/archive/API_DOCUMENTATION.md">API_DOCUMENTATION.md</a> - REST API reference (if available)</li>
</ul>

<h3 id="support">Support</h3>
<ul>
<li>GitHub Issues: https://github.com/mattiIce/PBX/issues</li>
<li>Community Forum: (if available)</li>
</ul>

<h3 id="external-resources">External Resources</h3>
<ul>
<li>SIP Protocol: RFC 3261</li>
<li>RTP Protocol: RFC 3550</li>
<li>VoIP Troubleshooting: https://www.voip-info.org/</li>
</ul>

<hr>

<strong>Document Version:</strong> 1.0.0  
<strong>Last Updated:</strong> 2025-12-29  
<strong>Maintained by:</strong> PBX Development Team

<hr>

<h2 id="quick-diagnostic-commands">Quick Diagnostic Commands</h2>

</code>`<code>bash
<h1 id="full-system-check">Full system check</h1>
<p>sudo systemctl status pbx</p>
<p>curl -k https://localhost:9000/api/status</p>
<p>sudo ufw status</p>
<p>sudo netstat -tlnp | grep -E "(5060|9000)"</p>
<p>python scripts/verify_database.py</p>

<h1 id="check-logs-for-errors">Check logs for errors</h1>
<p>tail -f logs/pbx.log | grep -i error</p>

<h1 id="test-basic-functionality">Test basic functionality</h1>
<p>curl -k https://localhost:9000/api/extensions</p>
<p>curl -k https://localhost:9000/api/calls</p>

<h1 id="monitor-real-time-activity">Monitor real-time activity</h1>
<p>tail -f logs/pbx.log</p>
</code>``

    </div>
</body>
</html>
