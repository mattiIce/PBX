
================================================================================
Test Run Started: 2025-12-08 14:36:20
================================================================================

[2025-12-08 14:36:20] FAILED: test_basic.py
  Return value: False (expected True)

  Test Output:
    ============================================================
    Running PBX System Tests
    ============================================================
    
    Testing SIP message parsing...
    ✓ SIP message parsing works
    
    Testing SIP message building...
    ✓ SIP message building works
    
    Testing call management...
    ✓ Call management works
    
    Testing extensions...
    ✓ Extensions work
    
    Testing configuration...
    ✗ Test failed: test_config
      Error: Expected at least one extension
    
    ============================================================
    Results: 4 passed, 1 failed
    ============================================================

[2025-12-08 14:36:30] FAILED: test_extension_db_registration.py
  Return value: False (expected True)

  Test Output:
    ============================================================
    Running Extension Database Registration Tests
    ============================================================
    Testing database-based extension registration...
      ✓ Added extension 9999 to database
      ✓ Extension verified in database: Test Database Extension
      ✓ Database extension registered successfully
      ✓ Extension marked as registered in registry
      ✓ Phone tracked in database: IP=192.168.1.200
    ✓ Database-based extension registration works
    Testing config-based extension registration (backward compatibility)...
    
    ✗ Test failed: Registration of config extension failed

  Test Errors:
    2025-12-08 14:36:30 - PBX - INFO - Database backend: postgresql
    2025-12-08 14:36:30 - PBX - INFO - Initiating database connection (type: postgresql)...
    2025-12-08 14:36:30 - PBX - INFO - Connecting to PostgreSQL database...
    2025-12-08 14:36:30 - PBX - INFO -   Host: localhost
    2025-12-08 14:36:30 - PBX - INFO -   Port: 5432
    2025-12-08 14:36:30 - PBX - INFO -   Database: pbx_system
    2025-12-08 14:36:30 - PBX - INFO -   User: pbx_user
    2025-12-08 14:36:30 - PBX - INFO - ✓ Successfully connected to PostgreSQL database
    2025-12-08 14:36:30 - PBX - INFO -   Connection established: localhost:5432/pbx_system
    2025-12-08 14:36:30 - PBX - INFO - Creating database tables...
    2025-12-08 14:36:30 - PBX - INFO - Checking for schema migrations...
    2025-12-08 14:36:30 - PBX - INFO - Schema migration check complete
    2025-12-08 14:36:30 - PBX - INFO - Database tables created successfully
    2025-12-08 14:36:30 - PBX - INFO - Database backend initialized successfully (postgresql)
    2025-12-08 14:36:30 - PBX - INFO - Extensions, voicemail metadata, and phone registrations will be stored in database
    2025-12-08 14:36:30 - PBX - INFO - FIPS 140-2 compliant encryption ENABLED
    2025-12-08 14:36:30 - PBX - INFO -   ✓ Using PBKDF2-HMAC-SHA256 for password hashing
    2025-12-08 14:36:30 - PBX - INFO -   ✓ Using AES-256-GCM for data encryption
    2025-12-08 14:36:30 - PBX - INFO -   ✓ 600,000 iterations for key derivation (OWASP 2024 recommendation)
    2025-12-08 14:36:30 - PBX - INFO - Loading 26 extensions from database
    2025-12-08 14:36:30 - PBX - INFO - Loaded extension 1501 (Lisa Dingman) [AD]
    2025-12-08 14:36:30 - PBX - INFO - Loaded extension 1503 (Joshua Blovsky) [AD]
    2025-12-08 14:36:30 - PBX - INFO - Loaded extension 1506 (Tember Laster) [AD]
    2025-12-08 14:36:30 - PBX - INFO - Loaded extension 1509 (Debbie Comstock) [AD]
    2025-12-08 14:36:30 - PBX - INFO - Loaded extension 1510 (Mike Chinavare) [AD]
    2025-12-08 14:36:30 - PBX - INFO - Loaded extension 1511 (Laura Anderson) [AD]
    2025-12-08 14:36:30 - PBX - INFO - Loaded extension 1512 (Alec Anderson) [AD]
    2025-12-08 14:36:30 - PBX - INFO - Loaded extension 1517 (Acadia Szalka) [AD]
    2025-12-08 14:36:30 - PBX - INFO - Loaded extension 1519 (Bill Sautter) [AD]
    2025-12-08 14:36:30 - PBX - INFO - Loaded extension 1520 (Mike Millis) [AD]
    2025-12-08 14:36:30 - PBX - INFO - Loaded extension 1521 (Jamar Latimore) [AD]
    2025-12-08 14:36:30 - PBX - INFO - Loaded extension 1522 (Mike Baranyia) [AD]
    2025-12-08 14:36:30 - PBX - INFO - Loaded extension 1526 (Dan Polkinghorne) [AD]
    2025-12-08 14:36:30 - PBX - INFO - Loaded extension 1527 (Cori Lafferty) [AD]
    2025-12-08 14:36:30 - PBX - INFO - Loaded extension 1529 (Chris Beamer) [AD]
    2025-12-08 14:36:30 - PBX - INFO - Loaded extension 1530 (Brian Butki) [AD]
    2025-12-08 14:36:30 - PBX - INFO - Loaded extension 1537 (Codi Mattinson) [AD]
    2025-12-08 14:36:30 - PBX - INFO - Loaded extension 1540 (Merry Medina) [AD]
    2025-12-08 14:36:30 - PBX - INFO - Loaded extension 1541 (Lexi N. Barnum) [AD]
    2025-12-08 14:36:30 - PBX - INFO - Loaded extension 1544 (Chad Elliott) [AD]
    2025-12-08 14:36:30 - PBX - INFO - Loaded extension 1546 (Alex Gerlants) [AD]
    2025-12-08 14:36:30 - PBX - INFO - Loaded extension 1548 (Scott Hole) [AD]
    2025-12-08 14:36:30 - PBX - INFO - Loaded extension 1551 (Donald Williams) [AD]
    2025-12-08 14:36:30 - PBX - INFO - Loaded extension 2081 (Rob Fleming) [AD]
    2025-12-08 14:36:30 - PBX - INFO - Loaded extension 2082 (Mike Elliott) [AD]
    2025-12-08 14:36:30 - PBX - INFO - Loaded extension 2087 (Melissa Schrah) [AD]
    2025-12-08 14:36:30 - PBX - INFO - Email notifications enabled - SMTP: 192.168.1.75:465, From: Voicemail@albl.com
    2025-12-08 14:36:30 - PBX - INFO - Started daily reminder thread
    2025-12-08 14:36:30 - PBX - INFO - Statistics and analytics engine initialized
    2025-12-08 14:36:30 - PBX - INFO - Auto Attendant initialized on extension 0
    2025-12-08 14:36:30 - PBX - INFO - Menu options: 4
    2025-12-08 14:36:30 - PBX - INFO - Auto Attendant initialized on extension 0
    2025-12-08 14:36:30 - PBX - INFO - Phone provisioning will use database for persistent storage
    2025-12-08 14:36:30 - PBX - INFO - Loaded 3 provisioned devices from database
    2025-12-08 14:36:30 - PBX - INFO - Loaded 6 built-in phone templates
    2025-12-08 14:36:30 - PBX - INFO - Loaded custom template for polycom vvx450
    2025-12-08 14:36:30 - PBX - INFO - Loaded custom template for grandstream gxp2170
    2025-12-08 14:36:30 - PBX - INFO - Loaded custom template for zultys zip33g
    2025-12-08 14:36:30 - PBX - INFO - Loaded custom template for yealink t46s
    2025-12-08 14:36:30 - PBX - INFO - Loaded custom template for zultys zip37g
    2025-12-08 14:36:30 - PBX - INFO - Loaded custom template for cisco spa504g
    2025-12-08 14:36:30 - PBX - INFO - Phone provisioning initialized
    2025-12-08 14:36:30 - PBX - INFO - Provisioning URL format: http://{{SERVER_IP}}:{{PORT}}/provision/{mac}.cfg
    2025-12-08 14:36:30 - PBX - INFO - Server external IP: 192.168.1.14
    2025-12-08 14:36:30 - PBX - INFO - API port: 8080
    2025-12-08 14:36:30 - PBX - INFO - Active Directory integration enabled
    2025-12-08 14:36:30 - PBX - INFO - Active Directory integration initialized
    2025-12-08 14:36:30 - PBX - INFO - Webhook system disabled
    2025-12-08 14:36:30 - PBX - INFO - WebRTC signaling server enabled
    2025-12-08 14:36:30 - PBX - INFO - Started WebRTC session cleanup thread
    2025-12-08 14:36:30 - PBX - INFO - WebRTC to SIP gateway initialized
    2025-12-08 14:36:30 - PBX - INFO - WebRTC browser calling initialized
    2025-12-08 14:36:30 - PBX - INFO - Loaded CRM provider: PhoneBook
    2025-12-08 14:36:30 - PBX - INFO - Loaded CRM provider: ActiveDirectory
    2025-12-08 14:36:30 - PBX - INFO - CRM integration enabled
    2025-12-08 14:36:30 - PBX - INFO - CRM integration and screen pop initialized
    2025-12-08 14:36:30 - PBX - INFO - Hot-desking system enabled
    2025-12-08 14:36:30 - PBX - INFO - Started hot-desking auto-logout thread
    2025-12-08 14:36:30 - PBX - INFO - Hot-desking system initialized
    2025-12-08 14:36:30 - PBX - INFO - Threat detection database schema initialized
    2025-12-08 14:36:30 - PBX - INFO - Enhanced threat detection initialized
    2025-12-08 14:36:30 - PBX - INFO - PBX Core initialized with all features
    2025-12-08 14:36:30 - PBX - INFO - Extension 9999 registered from ('192.168.1.200', 5060)
    2025-12-08 14:36:30 - PBX - INFO - Extension 9999 registered from ('192.168.1.200', 5060)
    2025-12-08 14:36:30 - PBX - INFO - Stored phone registration: ext=9999, ip=192.168.1.200 (no MAC)
    2025-12-08 14:36:30 - PBX - INFO - Database backend: postgresql
    2025-12-08 14:36:30 - PBX - INFO - Initiating database connection (type: postgresql)...
    2025-12-08 14:36:30 - PBX - INFO - Connecting to PostgreSQL database...
    2025-12-08 14:36:30 - PBX - INFO -   Host: localhost
    2025-12-08 14:36:30 - PBX - INFO -   Port: 5432
    2025-12-08 14:36:30 - PBX - INFO -   Database: pbx_system
    2025-12-08 14:36:30 - PBX - INFO -   User: pbx_user
    2025-12-08 14:36:30 - PBX - INFO - ✓ Successfully connected to PostgreSQL database
    2025-12-08 14:36:30 - PBX - INFO -   Connection established: localhost:5432/pbx_system
    2025-12-08 14:36:30 - PBX - INFO - Creating database tables...
    2025-12-08 14:36:30 - PBX - INFO - Checking for schema migrations...
    2025-12-08 14:36:30 - PBX - INFO - Schema migration check complete
    2025-12-08 14:36:30 - PBX - INFO - Database tables created successfully
    2025-12-08 14:36:30 - PBX - INFO - Database backend initialized successfully (postgresql)
    2025-12-08 14:36:30 - PBX - INFO - Extensions, voicemail metadata, and phone registrations will be stored in database
    2025-12-08 14:36:30 - PBX - INFO - Loading 26 extensions from database
    2025-12-08 14:36:30 - PBX - INFO - Loaded extension 1501 (Lisa Dingman) [AD]
    2025-12-08 14:36:30 - PBX - INFO - Loaded extension 1503 (Joshua Blovsky) [AD]
    2025-12-08 14:36:30 - PBX - INFO - Loaded extension 1506 (Tember Laster) [AD]
    2025-12-08 14:36:30 - PBX - INFO - Loaded extension 1509 (Debbie Comstock) [AD]
    2025-12-08 14:36:30 - PBX - INFO - Loaded extension 1510 (Mike Chinavare) [AD]
    2025-12-08 14:36:30 - PBX - INFO - Loaded extension 1511 (Laura Anderson) [AD]
    2025-12-08 14:36:30 - PBX - INFO - Loaded extension 1512 (Alec Anderson) [AD]
    2025-12-08 14:36:30 - PBX - INFO - Loaded extension 1517 (Acadia Szalka) [AD]
    2025-12-08 14:36:30 - PBX - INFO - Loaded extension 1519 (Bill Sautter) [AD]
    2025-12-08 14:36:30 - PBX - INFO - Loaded extension 1520 (Mike Millis) [AD]
    2025-12-08 14:36:30 - PBX - INFO - Loaded extension 1521 (Jamar Latimore) [AD]
    2025-12-08 14:36:30 - PBX - INFO - Loaded extension 1522 (Mike Baranyia) [AD]
    2025-12-08 14:36:30 - PBX - INFO - Loaded extension 1526 (Dan Polkinghorne) [AD]
    2025-12-08 14:36:30 - PBX - INFO - Loaded extension 1527 (Cori Lafferty) [AD]
    2025-12-08 14:36:30 - PBX - INFO - Loaded extension 1529 (Chris Beamer) [AD]
    2025-12-08 14:36:30 - PBX - INFO - Loaded extension 1530 (Brian Butki) [AD]
    2025-12-08 14:36:30 - PBX - INFO - Loaded extension 1537 (Codi Mattinson) [AD]
    2025-12-08 14:36:30 - PBX - INFO - Loaded extension 1540 (Merry Medina) [AD]
    2025-12-08 14:36:30 - PBX - INFO - Loaded extension 1541 (Lexi N. Barnum) [AD]
    2025-12-08 14:36:30 - PBX - INFO - Loaded extension 1544 (Chad Elliott) [AD]
    2025-12-08 14:36:30 - PBX - INFO - Loaded extension 1546 (Alex Gerlants) [AD]
    2025-12-08 14:36:30 - PBX - INFO - Loaded extension 1548 (Scott Hole) [AD]
    2025-12-08 14:36:30 - PBX - INFO - Loaded extension 1551 (Donald Williams) [AD]
    2025-12-08 14:36:30 - PBX - INFO - Loaded extension 2081 (Rob Fleming) [AD]
    2025-12-08 14:36:30 - PBX - INFO - Loaded extension 2082 (Mike Elliott) [AD]
    2025-12-08 14:36:30 - PBX - INFO - Loaded extension 2087 (Melissa Schrah) [AD]
    2025-12-08 14:36:30 - PBX - INFO - Email notifications enabled - SMTP: 192.168.1.75:465, From: Voicemail@albl.com
    2025-12-08 14:36:30 - PBX - INFO - Started daily reminder thread
    2025-12-08 14:36:30 - PBX - INFO - Statistics and analytics engine initialized
    2025-12-08 14:36:30 - PBX - INFO - Auto Attendant initialized on extension 0
    2025-12-08 14:36:30 - PBX - INFO - Menu options: 4
    2025-12-08 14:36:30 - PBX - INFO - Auto Attendant initialized on extension 0
    2025-12-08 14:36:30 - PBX - INFO - Phone provisioning will use database for persistent storage
    2025-12-08 14:36:30 - PBX - INFO - Loaded 3 provisioned devices from database
    2025-12-08 14:36:30 - PBX - INFO - Loaded 6 built-in phone templates
    2025-12-08 14:36:30 - PBX - INFO - Loaded custom template for polycom vvx450
    2025-12-08 14:36:30 - PBX - INFO - Loaded custom template for grandstream gxp2170
    2025-12-08 14:36:30 - PBX - INFO - Loaded custom template for zultys zip33g
    2025-12-08 14:36:30 - PBX - INFO - Loaded custom template for yealink t46s
    2025-12-08 14:36:30 - PBX - INFO - Loaded custom template for zultys zip37g
    2025-12-08 14:36:30 - PBX - INFO - Loaded custom template for cisco spa504g
    2025-12-08 14:36:30 - PBX - INFO - Phone provisioning initialized
    2025-12-08 14:36:30 - PBX - INFO - Provisioning URL format: http://{{SERVER_IP}}:{{PORT}}/provision/{mac}.cfg
    2025-12-08 14:36:30 - PBX - INFO - Server external IP: 192.168.1.14
    2025-12-08 14:36:30 - PBX - INFO - API port: 8080
    2025-12-08 14:36:30 - PBX - INFO - Active Directory integration enabled
    2025-12-08 14:36:30 - PBX - INFO - Active Directory integration initialized
    2025-12-08 14:36:30 - PBX - INFO - Webhook system disabled
    2025-12-08 14:36:30 - PBX - INFO - WebRTC signaling server enabled
    2025-12-08 14:36:30 - PBX - INFO - Started WebRTC session cleanup thread
    2025-12-08 14:36:30 - PBX - INFO - WebRTC to SIP gateway initialized
    2025-12-08 14:36:30 - PBX - INFO - WebRTC browser calling initialized
    2025-12-08 14:36:30 - PBX - INFO - Loaded CRM provider: PhoneBook
    2025-12-08 14:36:30 - PBX - INFO - Loaded CRM provider: ActiveDirectory
    2025-12-08 14:36:30 - PBX - INFO - CRM integration enabled
    2025-12-08 14:36:30 - PBX - INFO - CRM integration and screen pop initialized
    2025-12-08 14:36:30 - PBX - INFO - Hot-desking system enabled
    2025-12-08 14:36:30 - PBX - INFO - Started hot-desking auto-logout thread
    2025-12-08 14:36:30 - PBX - INFO - Hot-desking system initialized
    2025-12-08 14:36:30 - PBX - INFO - Threat detection database schema initialized
    2025-12-08 14:36:30 - PBX - INFO - Enhanced threat detection initialized
    2025-12-08 14:36:30 - PBX - INFO - PBX Core initialized with all features
    2025-12-08 14:36:30 - PBX - WARNING - Unknown extension 1001 attempted registration
    Traceback (most recent call last):
      File "/root/PBX/tests/test_extension_db_registration.py", line 204, in run_all_tests
        test_config_extension_still_works()
      File "/root/PBX/tests/test_extension_db_registration.py", line 96, in test_config_extension_still_works
        assert success, "Registration of config extension failed"
               ^^^^^^^
    AssertionError: Registration of config extension failed

[2025-12-08 14:36:32] FAILED: test_greeting_recording.py
  Return value: False (expected True)

  Test Output:
    ============================================================
    Running Voicemail Greeting Recording Tests
    ============================================================
    
    Testing greeting storage...
    ✓ Greeting storage works
    Testing greeting deletion...
    ✓ Greeting deletion works
    Testing IVR options menu...
    ✓ IVR options menu works
    Testing IVR greeting recording...
    ✓ IVR greeting recording works
    Testing IVR save recorded greeting...
    ✗ test_ivr_save_recorded_greeting failed: Mailbox should have custom greeting
    Testing main menu to options navigation...
    ✓ Main menu to options navigation works
    Testing greeting persistence...
    ✓ Greeting persistence works
    
    ============================================================
    Results: 6 passed, 1 failed
    ============================================================

[2025-12-08 14:37:27] FAILED: test_phone_registration_integration.py
  Return value: False (expected True)

  Test Output:
    ============================================================
    Running Phone Registration Integration Tests
    ============================================================
    Testing MAC address extraction from SIP headers...
      ✓ Extracted MAC from Contact: 001565123456
      ✓ Extracted MAC from User-Agent: 001565aabbcc
      ✓ Correctly handled no MAC: None
      ✓ Extracted MAC with hyphens: 001565112233
    ✓ MAC address extraction works
    Testing phone registration storage...
    
    ✗ Test failed: Registration failed

  Test Errors:
    2025-12-08 14:37:27 - PBX - INFO - Database backend: postgresql
    2025-12-08 14:37:27 - PBX - INFO - Initiating database connection (type: postgresql)...
    2025-12-08 14:37:27 - PBX - INFO - Connecting to PostgreSQL database...
    2025-12-08 14:37:27 - PBX - INFO -   Host: localhost
    2025-12-08 14:37:27 - PBX - INFO -   Port: 5432
    2025-12-08 14:37:27 - PBX - INFO -   Database: pbx_system
    2025-12-08 14:37:27 - PBX - INFO -   User: pbx_user
    2025-12-08 14:37:27 - PBX - INFO - ✓ Successfully connected to PostgreSQL database
    2025-12-08 14:37:27 - PBX - INFO -   Connection established: localhost:5432/pbx_system
    2025-12-08 14:37:27 - PBX - INFO - Creating database tables...
    2025-12-08 14:37:27 - PBX - INFO - Checking for schema migrations...
    2025-12-08 14:37:27 - PBX - INFO - Schema migration check complete
    2025-12-08 14:37:27 - PBX - INFO - Database tables created successfully
    2025-12-08 14:37:27 - PBX - INFO - Database backend initialized successfully (postgresql)
    2025-12-08 14:37:27 - PBX - INFO - Extensions, voicemail metadata, and phone registrations will be stored in database
    2025-12-08 14:37:27 - PBX - INFO - Loading 26 extensions from database
    2025-12-08 14:37:27 - PBX - INFO - Loaded extension 1501 (Lisa Dingman) [AD]
    2025-12-08 14:37:27 - PBX - INFO - Loaded extension 1503 (Joshua Blovsky) [AD]
    2025-12-08 14:37:27 - PBX - INFO - Loaded extension 1506 (Tember Laster) [AD]
    2025-12-08 14:37:27 - PBX - INFO - Loaded extension 1509 (Debbie Comstock) [AD]
    2025-12-08 14:37:27 - PBX - INFO - Loaded extension 1510 (Mike Chinavare) [AD]
    2025-12-08 14:37:27 - PBX - INFO - Loaded extension 1511 (Laura Anderson) [AD]
    2025-12-08 14:37:27 - PBX - INFO - Loaded extension 1512 (Alec Anderson) [AD]
    2025-12-08 14:37:27 - PBX - INFO - Loaded extension 1517 (Acadia Szalka) [AD]
    2025-12-08 14:37:27 - PBX - INFO - Loaded extension 1519 (Bill Sautter) [AD]
    2025-12-08 14:37:27 - PBX - INFO - Loaded extension 1520 (Mike Millis) [AD]
    2025-12-08 14:37:27 - PBX - INFO - Loaded extension 1521 (Jamar Latimore) [AD]
    2025-12-08 14:37:27 - PBX - INFO - Loaded extension 1522 (Mike Baranyia) [AD]
    2025-12-08 14:37:27 - PBX - INFO - Loaded extension 1526 (Dan Polkinghorne) [AD]
    2025-12-08 14:37:27 - PBX - INFO - Loaded extension 1527 (Cori Lafferty) [AD]
    2025-12-08 14:37:27 - PBX - INFO - Loaded extension 1529 (Chris Beamer) [AD]
    2025-12-08 14:37:27 - PBX - INFO - Loaded extension 1530 (Brian Butki) [AD]
    2025-12-08 14:37:27 - PBX - INFO - Loaded extension 1537 (Codi Mattinson) [AD]
    2025-12-08 14:37:27 - PBX - INFO - Loaded extension 1540 (Merry Medina) [AD]
    2025-12-08 14:37:27 - PBX - INFO - Loaded extension 1541 (Lexi N. Barnum) [AD]
    2025-12-08 14:37:27 - PBX - INFO - Loaded extension 1544 (Chad Elliott) [AD]
    2025-12-08 14:37:27 - PBX - INFO - Loaded extension 1546 (Alex Gerlants) [AD]
    2025-12-08 14:37:27 - PBX - INFO - Loaded extension 1548 (Scott Hole) [AD]
    2025-12-08 14:37:27 - PBX - INFO - Loaded extension 1551 (Donald Williams) [AD]
    2025-12-08 14:37:27 - PBX - INFO - Loaded extension 2081 (Rob Fleming) [AD]
    2025-12-08 14:37:27 - PBX - INFO - Loaded extension 2082 (Mike Elliott) [AD]
    2025-12-08 14:37:27 - PBX - INFO - Loaded extension 2087 (Melissa Schrah) [AD]
    2025-12-08 14:37:27 - PBX - INFO - Email notifications enabled - SMTP: 192.168.1.75:465, From: Voicemail@albl.com
    2025-12-08 14:37:27 - PBX - INFO - Started daily reminder thread
    2025-12-08 14:37:27 - PBX - INFO - Statistics and analytics engine initialized
    2025-12-08 14:37:27 - PBX - INFO - Auto Attendant initialized on extension 0
    2025-12-08 14:37:27 - PBX - INFO - Menu options: 4
    2025-12-08 14:37:27 - PBX - INFO - Auto Attendant initialized on extension 0
    2025-12-08 14:37:27 - PBX - INFO - Phone provisioning will use database for persistent storage
    2025-12-08 14:37:27 - PBX - INFO - Loaded 3 provisioned devices from database
    2025-12-08 14:37:27 - PBX - INFO - Loaded 6 built-in phone templates
    2025-12-08 14:37:27 - PBX - INFO - Loaded custom template for polycom vvx450
    2025-12-08 14:37:27 - PBX - INFO - Loaded custom template for grandstream gxp2170
    2025-12-08 14:37:27 - PBX - INFO - Loaded custom template for zultys zip33g
    2025-12-08 14:37:27 - PBX - INFO - Loaded custom template for yealink t46s
    2025-12-08 14:37:27 - PBX - INFO - Loaded custom template for zultys zip37g
    2025-12-08 14:37:27 - PBX - INFO - Loaded custom template for cisco spa504g
    2025-12-08 14:37:27 - PBX - INFO - Phone provisioning initialized
    2025-12-08 14:37:27 - PBX - INFO - Provisioning URL format: http://{{SERVER_IP}}:{{PORT}}/provision/{mac}.cfg
    2025-12-08 14:37:27 - PBX - INFO - Server external IP: 192.168.1.14
    2025-12-08 14:37:27 - PBX - INFO - API port: 8080
    2025-12-08 14:37:27 - PBX - INFO - Active Directory integration enabled
    2025-12-08 14:37:27 - PBX - INFO - Active Directory integration initialized
    2025-12-08 14:37:27 - PBX - INFO - Webhook system disabled
    2025-12-08 14:37:27 - PBX - INFO - WebRTC signaling server enabled
    2025-12-08 14:37:27 - PBX - INFO - Started WebRTC session cleanup thread
    2025-12-08 14:37:27 - PBX - INFO - WebRTC to SIP gateway initialized
    2025-12-08 14:37:27 - PBX - INFO - WebRTC browser calling initialized
    2025-12-08 14:37:27 - PBX - INFO - Loaded CRM provider: PhoneBook
    2025-12-08 14:37:27 - PBX - INFO - Loaded CRM provider: ActiveDirectory
    2025-12-08 14:37:27 - PBX - INFO - CRM integration enabled
    2025-12-08 14:37:27 - PBX - INFO - CRM integration and screen pop initialized
    2025-12-08 14:37:27 - PBX - INFO - Hot-desking system enabled
    2025-12-08 14:37:27 - PBX - INFO - Started hot-desking auto-logout thread
    2025-12-08 14:37:27 - PBX - INFO - Hot-desking system initialized
    2025-12-08 14:37:27 - PBX - INFO - Threat detection database schema initialized
    2025-12-08 14:37:27 - PBX - INFO - Enhanced threat detection initialized
    2025-12-08 14:37:27 - PBX - INFO - PBX Core initialized with all features
    2025-12-08 14:37:27 - PBX - INFO - Database backend: postgresql
    2025-12-08 14:37:27 - PBX - INFO - Initiating database connection (type: postgresql)...
    2025-12-08 14:37:27 - PBX - INFO - Connecting to PostgreSQL database...
    2025-12-08 14:37:27 - PBX - INFO -   Host: localhost
    2025-12-08 14:37:27 - PBX - INFO -   Port: 5432
    2025-12-08 14:37:27 - PBX - INFO -   Database: pbx_system
    2025-12-08 14:37:27 - PBX - INFO -   User: pbx_user
    2025-12-08 14:37:27 - PBX - INFO - ✓ Successfully connected to PostgreSQL database
    2025-12-08 14:37:27 - PBX - INFO -   Connection established: localhost:5432/pbx_system
    2025-12-08 14:37:27 - PBX - INFO - Creating database tables...
    2025-12-08 14:37:27 - PBX - INFO - Checking for schema migrations...
    2025-12-08 14:37:27 - PBX - INFO - Schema migration check complete
    2025-12-08 14:37:27 - PBX - INFO - Database tables created successfully
    2025-12-08 14:37:27 - PBX - INFO - Database backend initialized successfully (postgresql)
    2025-12-08 14:37:27 - PBX - INFO - Extensions, voicemail metadata, and phone registrations will be stored in database
    2025-12-08 14:37:27 - PBX - INFO - Loading 26 extensions from database
    2025-12-08 14:37:27 - PBX - INFO - Loaded extension 1501 (Lisa Dingman) [AD]
    2025-12-08 14:37:27 - PBX - INFO - Loaded extension 1503 (Joshua Blovsky) [AD]
    2025-12-08 14:37:27 - PBX - INFO - Loaded extension 1506 (Tember Laster) [AD]
    2025-12-08 14:37:27 - PBX - INFO - Loaded extension 1509 (Debbie Comstock) [AD]
    2025-12-08 14:37:27 - PBX - INFO - Loaded extension 1510 (Mike Chinavare) [AD]
    2025-12-08 14:37:27 - PBX - INFO - Loaded extension 1511 (Laura Anderson) [AD]
    2025-12-08 14:37:27 - PBX - INFO - Loaded extension 1512 (Alec Anderson) [AD]
    2025-12-08 14:37:27 - PBX - INFO - Loaded extension 1517 (Acadia Szalka) [AD]
    2025-12-08 14:37:27 - PBX - INFO - Loaded extension 1519 (Bill Sautter) [AD]
    2025-12-08 14:37:27 - PBX - INFO - Loaded extension 1520 (Mike Millis) [AD]
    2025-12-08 14:37:27 - PBX - INFO - Loaded extension 1521 (Jamar Latimore) [AD]
    2025-12-08 14:37:27 - PBX - INFO - Loaded extension 1522 (Mike Baranyia) [AD]
    2025-12-08 14:37:27 - PBX - INFO - Loaded extension 1526 (Dan Polkinghorne) [AD]
    2025-12-08 14:37:27 - PBX - INFO - Loaded extension 1527 (Cori Lafferty) [AD]
    2025-12-08 14:37:27 - PBX - INFO - Loaded extension 1529 (Chris Beamer) [AD]
    2025-12-08 14:37:27 - PBX - INFO - Loaded extension 1530 (Brian Butki) [AD]
    2025-12-08 14:37:27 - PBX - INFO - Loaded extension 1537 (Codi Mattinson) [AD]
    2025-12-08 14:37:27 - PBX - INFO - Loaded extension 1540 (Merry Medina) [AD]
    2025-12-08 14:37:27 - PBX - INFO - Loaded extension 1541 (Lexi N. Barnum) [AD]
    2025-12-08 14:37:27 - PBX - INFO - Loaded extension 1544 (Chad Elliott) [AD]
    2025-12-08 14:37:27 - PBX - INFO - Loaded extension 1546 (Alex Gerlants) [AD]
    2025-12-08 14:37:27 - PBX - INFO - Loaded extension 1548 (Scott Hole) [AD]
    2025-12-08 14:37:27 - PBX - INFO - Loaded extension 1551 (Donald Williams) [AD]
    2025-12-08 14:37:27 - PBX - INFO - Loaded extension 2081 (Rob Fleming) [AD]
    2025-12-08 14:37:27 - PBX - INFO - Loaded extension 2082 (Mike Elliott) [AD]
    2025-12-08 14:37:27 - PBX - INFO - Loaded extension 2087 (Melissa Schrah) [AD]
    2025-12-08 14:37:27 - PBX - INFO - Email notifications enabled - SMTP: 192.168.1.75:465, From: Voicemail@albl.com
    2025-12-08 14:37:27 - PBX - INFO - Started daily reminder thread
    2025-12-08 14:37:27 - PBX - INFO - Statistics and analytics engine initialized
    2025-12-08 14:37:27 - PBX - INFO - Auto Attendant initialized on extension 0
    2025-12-08 14:37:27 - PBX - INFO - Menu options: 4
    2025-12-08 14:37:27 - PBX - INFO - Auto Attendant initialized on extension 0
    2025-12-08 14:37:27 - PBX - INFO - Phone provisioning will use database for persistent storage
    2025-12-08 14:37:27 - PBX - INFO - Loaded 3 provisioned devices from database
    2025-12-08 14:37:27 - PBX - INFO - Loaded 6 built-in phone templates
    2025-12-08 14:37:27 - PBX - INFO - Loaded custom template for polycom vvx450
    2025-12-08 14:37:27 - PBX - INFO - Loaded custom template for grandstream gxp2170
    2025-12-08 14:37:27 - PBX - INFO - Loaded custom template for zultys zip33g
    2025-12-08 14:37:27 - PBX - INFO - Loaded custom template for yealink t46s
    2025-12-08 14:37:27 - PBX - INFO - Loaded custom template for zultys zip37g
    2025-12-08 14:37:27 - PBX - INFO - Loaded custom template for cisco spa504g
    2025-12-08 14:37:27 - PBX - INFO - Phone provisioning initialized
    2025-12-08 14:37:27 - PBX - INFO - Provisioning URL format: http://{{SERVER_IP}}:{{PORT}}/provision/{mac}.cfg
    2025-12-08 14:37:27 - PBX - INFO - Server external IP: 192.168.1.14
    2025-12-08 14:37:27 - PBX - INFO - API port: 8080
    2025-12-08 14:37:27 - PBX - INFO - Active Directory integration enabled
    2025-12-08 14:37:27 - PBX - INFO - Active Directory integration initialized
    2025-12-08 14:37:27 - PBX - INFO - Webhook system disabled
    2025-12-08 14:37:27 - PBX - INFO - WebRTC signaling server enabled
    2025-12-08 14:37:27 - PBX - INFO - Started WebRTC session cleanup thread
    2025-12-08 14:37:27 - PBX - INFO - WebRTC to SIP gateway initialized
    2025-12-08 14:37:27 - PBX - INFO - WebRTC browser calling initialized
    2025-12-08 14:37:27 - PBX - INFO - Loaded CRM provider: PhoneBook
    2025-12-08 14:37:27 - PBX - INFO - Loaded CRM provider: ActiveDirectory
    2025-12-08 14:37:27 - PBX - INFO - CRM integration enabled
    2025-12-08 14:37:27 - PBX - INFO - CRM integration and screen pop initialized
    2025-12-08 14:37:27 - PBX - INFO - Hot-desking system enabled
    2025-12-08 14:37:27 - PBX - INFO - Started hot-desking auto-logout thread
    2025-12-08 14:37:27 - PBX - INFO - Hot-desking system initialized
    2025-12-08 14:37:27 - PBX - INFO - Threat detection database schema initialized
    2025-12-08 14:37:27 - PBX - INFO - Enhanced threat detection initialized
    2025-12-08 14:37:27 - PBX - INFO - PBX Core initialized with all features
    2025-12-08 14:37:27 - PBX - INFO - Database disconnected
    2025-12-08 14:37:27 - PBX - INFO - Database backend: sqlite
    2025-12-08 14:37:27 - PBX - INFO - Initiating database connection (type: sqlite)...
    2025-12-08 14:37:27 - PBX - INFO - Connecting to SQLite database...
    2025-12-08 14:37:27 - PBX - INFO -   Database file: :memory:
    2025-12-08 14:37:27 - PBX - INFO - ✓ Successfully connected to SQLite database
    2025-12-08 14:37:27 - PBX - INFO -   Database path: /root/PBX/:memory:
    2025-12-08 14:37:27 - PBX - INFO - Creating database tables...
    2025-12-08 14:37:27 - PBX - INFO - Checking for schema migrations...
    2025-12-08 14:37:27 - PBX - INFO - Schema migration check complete
    2025-12-08 14:37:27 - PBX - INFO - Database tables created successfully
    2025-12-08 14:37:27 - PBX - WARNING - Unknown extension 1001 attempted registration

[2025-12-08 14:37:27] FAILED: test_provisioning.py
  Return value: False (expected True)

  Test Output:
    ============================================================
    Running Phone Provisioning Tests
    ============================================================
    Testing MAC address normalization...
    ✓ MAC address normalization works
    Testing phone template...
    ✓ Phone template works
    Testing device registration...
    ✓ Device registration works
    Testing supported vendors and models...
    ✓ Supported vendors and models work
    Testing built-in templates...
    ✓ Built-in templates exist
    Testing configuration generation...
    
    ✗ Test failed: Config generation failed

[2025-12-08 14:37:47] FAILED: test_threat_detection.py
  Return value: False (expected True)

  Test Output:
    ============================================================
    Enhanced Threat Detection Tests
    ============================================================
    
    Testing threat detector initialization...
      ✓ Threat detector initialized
    
    Testing IP blocking...
      ✓ IP initially not blocked
      ✓ IP successfully blocked
      ✓ IP successfully unblocked
    
    Testing automatic unblocking...
      ✓ IP blocked with short duration
      ✓ IP auto-unblocked after duration expired
    
    Testing failed attempt tracking...
      ✓ IP not blocked below threshold
        Attempt count after 4 attempts: 4
        Attempt count after 5 attempts: 0
        Attempt count after 6 attempts: 1
        Is blocked: True, Reason: Excessive failed login attempts (5)
      ✓ IP auto-blocked after exceeding failed attempt threshold
    
    Testing suspicious pattern detection...
      ✓ Pattern detected but below threshold
      ✓ Pattern becomes threat after exceeding threshold
      ✓ IP auto-blocked due to suspicious pattern
    
    Testing request pattern analysis...
      ✓ Normal request analyzed correctly
      ✓ Scanner user agent detected
        Threats: ['Scanner detected in user agent: nmap']
        Score: 30
    
    Testing threat detection with database...
      ✓ IP blocked with database persistence
      ✗ test_with_database failed with exception: IP should be blocked after reload from database
    
    ============================================================
    Results: 6 passed, 1 failed
    ============================================================

  Test Errors:
    Traceback (most recent call last):
      File "/root/PBX/tests/test_threat_detection.py", line 295, in run_all_tests
        if test():
           ^^^^^^
      File "/root/PBX/tests/test_threat_detection.py", line 270, in test_with_database
        raise e
      File "/root/PBX/tests/test_threat_detection.py", line 244, in test_with_database
        assert is_blocked, "IP should be blocked after reload from database"
               ^^^^^^^^^^
    AssertionError: IP should be blocked after reload from database

[2025-12-08 14:37:47] FAILED: test_voicemail_database.py
  Return value: False (expected True)

  Test Output:
    ============================================================
    Running Voicemail Database Tests
    ============================================================
    
    Testing database configuration...
    ✗ test_database_configuration failed: 
    Testing database backend initialization...
    ✓ Database backend initializes correctly
    Testing voicemail database integration...
    ✓ Voicemail database integration works correctly
    Testing voicemail system without database...
    ✓ Voicemail system works without database
    
    ============================================================
    Results: 3 passed, 1 failed
    ============================================================

  Test Errors:
    Traceback (most recent call last):
      File "/root/PBX/tests/test_voicemail_database.py", line 204, in run_all_tests
        test()
      File "/root/PBX/tests/test_voicemail_database.py", line 28, in test_database_configuration
        assert config.get('database.port') == 5432
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    AssertionError

[2025-12-08 14:37:47] FAILED: test_voicemail_email.py
  Return value: False (expected True)

  Test Output:
    ============================================================
    Running Voicemail Email Tests
    ============================================================
    
    Testing email notifier configuration...
    ✗ test_email_notifier_config failed: 
    Testing email notifier initialization...
    ✗ test_email_notifier_initialization failed: 
    Testing voicemail system with email integration...
    ✓ Voicemail system integrates with email correctly
    Testing extension email configuration...
    ✗ test_extension_email_configuration failed: 
    Testing no-answer timeout configuration...
    ✓ No-answer timeout configured correctly
    
    ============================================================
    Results: 2 passed, 3 failed
    ============================================================

[2025-12-08 14:38:07] FAILED: test_voicemail_transcription.py
  Return value: False (expected True)

  Test Errors:
    test_transcription_file_not_found (test_voicemail_transcription.TestVoicemailTranscription.test_transcription_file_not_found)
    Test transcription with non-existent file ... ok
    test_transcription_google_no_results (test_voicemail_transcription.TestVoicemailTranscription.test_transcription_google_no_results)
    Test Google transcription with no results ... ERROR
    test_transcription_google_success (test_voicemail_transcription.TestVoicemailTranscription.test_transcription_google_success)
    Test successful Google Cloud Speech-to-Text transcription ... ERROR
    test_transcription_result_structure (test_voicemail_transcription.TestVoicemailTranscription.test_transcription_result_structure)
    Test that transcription result has correct structure ... ok
    test_transcription_service_disabled (test_voicemail_transcription.TestVoicemailTranscription.test_transcription_service_disabled)
    Test transcription service when disabled ... ok
    test_transcription_unsupported_provider (test_voicemail_transcription.TestVoicemailTranscription.test_transcription_unsupported_provider)
    Test transcription with unsupported provider ... ok
    
    ======================================================================
    ERROR: test_transcription_google_no_results (test_voicemail_transcription.TestVoicemailTranscription.test_transcription_google_no_results)
    Test Google transcription with no results
    ----------------------------------------------------------------------
    Traceback (most recent call last):
      File "/usr/lib/python3.12/unittest/mock.py", line 1387, in patched
        with self.decoration_helper(patched,
      File "/usr/lib/python3.12/contextlib.py", line 137, in __enter__
        return next(self.gen)
               ^^^^^^^^^^^^^^
      File "/usr/lib/python3.12/unittest/mock.py", line 1369, in decoration_helper
        arg = exit_stack.enter_context(patching)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
      File "/usr/lib/python3.12/contextlib.py", line 526, in enter_context
        result = _enter(cm)
                 ^^^^^^^^^^
      File "/usr/lib/python3.12/unittest/mock.py", line 1458, in __enter__
        original, local = self.get_original()
                          ^^^^^^^^^^^^^^^^^^^
      File "/usr/lib/python3.12/unittest/mock.py", line 1431, in get_original
        raise AttributeError(
    AttributeError: <module 'pbx.features.voicemail_transcription' from '/root/PBX/pbx/features/voicemail_transcription.py'> does not have the attribute 'speech'
    
    ======================================================================
    ERROR: test_transcription_google_success (test_voicemail_transcription.TestVoicemailTranscription.test_transcription_google_success)
    Test successful Google Cloud Speech-to-Text transcription
    ----------------------------------------------------------------------
    Traceback (most recent call last):
      File "/usr/lib/python3.12/unittest/mock.py", line 1387, in patched
        with self.decoration_helper(patched,
      File "/usr/lib/python3.12/contextlib.py", line 137, in __enter__
        return next(self.gen)
               ^^^^^^^^^^^^^^
      File "/usr/lib/python3.12/unittest/mock.py", line 1369, in decoration_helper
        arg = exit_stack.enter_context(patching)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
      File "/usr/lib/python3.12/contextlib.py", line 526, in enter_context
        result = _enter(cm)
                 ^^^^^^^^^^
      File "/usr/lib/python3.12/unittest/mock.py", line 1458, in __enter__
        original, local = self.get_original()
                          ^^^^^^^^^^^^^^^^^^^
      File "/usr/lib/python3.12/unittest/mock.py", line 1431, in get_original
        raise AttributeError(
    AttributeError: <module 'pbx.features.voicemail_transcription' from '/root/PBX/pbx/features/voicemail_transcription.py'> does not have the attribute 'speech'
    
    ----------------------------------------------------------------------
    Ran 6 tests in 0.032s
    
    FAILED (errors=2)

================================================================================
Test Run Completed: 2025-12-08 14:38:44
Summary: 37 passed, 9 failed, 0 skipped
================================================================================
<<<<<<< Updated upstream

================================================================================
Test Run Started: 2025-12-08 22:36:49
================================================================================

[2025-12-08 22:36:50] FAILED: test_enterprise_integrations.py
  Return value: False (expected True)

  Test Output:
    ============================================================
    Running Enterprise Integration Tests
    ============================================================
    
    Testing Zoom Phone routing...
    ✓ Zoom Phone routing works
    
    Testing Teams Direct Routing...
    ✗ test_teams_direct_routing failed: Should successfully route with configured trunk
    
    Testing Outlook meeting reminder...
    ✗ test_outlook_meeting_reminder failed: Should successfully schedule reminder with PBX core
    
    Testing Active Directory sync...
    ✓ Active Directory integration structure validated
    
    Testing error handling...
    ✓ Error handling works correctly
    
    ============================================================
    Results: 3 passed, 2 failed
    ============================================================

================================================================================
Test Run Completed: 2025-12-08 22:38:34
Summary: 45 passed, 1 failed, 0 skipped
================================================================================

================================================================================
Test Run Started: 2025-12-08 22:37:37
================================================================================

[2025-12-08 22:37:37] FAILED: test_enterprise_integrations.py
  Return value: False (expected True)

  Test Output:
    ============================================================
    Running Enterprise Integration Tests
    ============================================================
    
    Testing Zoom Phone routing...
    ✓ Zoom Phone routing works
    
    Testing Teams Direct Routing...
    ✗ test_teams_direct_routing failed: Should successfully route with configured trunk
    
    Testing Outlook meeting reminder...
    ✗ test_outlook_meeting_reminder failed: Should successfully schedule reminder with PBX core
    
    Testing Active Directory sync...
    ✓ Active Directory integration structure validated
    
    Testing error handling...
    ✓ Error handling works correctly
    
    ============================================================
    Results: 3 passed, 2 failed
    ============================================================

================================================================================
Test Run Completed: 2025-12-08 22:39:21
Summary: 45 passed, 1 failed, 0 skipped
================================================================================
=======
>>>>>>> Stashed changes
