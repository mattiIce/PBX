name: Security Scanning

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    - cron: "0 2 * * 1"
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

env:
  PYTHON_VERSION: "3.13"
  UV_SYSTEM_PYTHON: "1"

jobs:
  dependency-check:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Install dependencies
        run: |
          set -e
          uv pip install -e "."
          uv pip install pip-audit

      - name: Run pip-audit
        id: pip-audit
        run: |
          set -e
          pip-audit --format json --output pip-audit-report.json || true
          pip-audit || echo "audit_failed=true" >> "$GITHUB_OUTPUT"

      - name: Upload pip-audit report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: pip-audit-report
          path: pip-audit-report.json
          if-no-files-found: ignore
          retention-days: 30

      - name: Check results
        if: steps.pip-audit.outputs.audit_failed == 'true'
        run: |
          echo "::warning::Vulnerabilities detected in dependencies!"
          echo "Review the uploaded artifacts for details."
          exit 1

  bandit-scan:
    name: Bandit Security Scan
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Install Bandit
        run: |
          set -e
          uv pip install "bandit[toml]"

      - name: Run Bandit
        run: |
          set -e
          bandit -r pbx/ -f json -o bandit-report.json -c pyproject.toml || true
          bandit -r pbx/ -c pyproject.toml

      - name: Upload Bandit report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: bandit-report
          path: bandit-report.json
          if-no-files-found: ignore
          retention-days: 30

  secrets-scan:
    name: Secret Detection
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

  docker-scan:
    name: Docker Image Scan
    runs-on: ubuntu-24.04
    if: github.event_name != 'pull_request'

    steps:
      - uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: docker build -t pbx-security-scan:latest .

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.34.0
        with:
          image-ref: "pbx-security-scan:latest"
          format: "sarif"
          output: "trivy-results.sarif"
          severity: "CRITICAL,HIGH"
          exit-code: "0"

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: "trivy-results.sarif"

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-24.04
    if: github.event_name == 'pull_request'

    steps:
      - uses: actions/checkout@v6

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
          deny-licenses: GPL-2.0, GPL-3.0

  security-summary:
    name: Security Summary
    needs: [dependency-check, bandit-scan, secrets-scan]
    runs-on: ubuntu-24.04
    if: always()

    steps:
      - name: Check security scan results
        run: |
          echo "## Security Scan Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          if [ "${{ needs.dependency-check.result }}" == "success" ]; then
            echo "- Dependency vulnerability scan: PASSED" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "- Dependency vulnerability scan: FAILED" >> "$GITHUB_STEP_SUMMARY"
          fi

          if [ "${{ needs.bandit-scan.result }}" == "success" ]; then
            echo "- Bandit security scan: PASSED" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "- Bandit security scan: FAILED" >> "$GITHUB_STEP_SUMMARY"
          fi

          if [ "${{ needs.secrets-scan.result }}" == "success" ]; then
            echo "- Secret detection: PASSED" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "- Secret detection: FAILED" >> "$GITHUB_STEP_SUMMARY"
          fi
