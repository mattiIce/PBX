apiVersion: v1
kind: Service
metadata:
  name: pbx-server
  namespace: pbx-system
  labels:
    app: pbx-server
spec:
  type: LoadBalancer
  selector:
    app: pbx-server
  ports:
  - name: https-api
    port: 8080
    targetPort: 8080
    protocol: TCP
  - name: sip
    port: 5060
    targetPort: 5060
    protocol: UDP
  # RTP port range (10000-20000) - Kubernetes Services cannot expose port ranges
  # This Service only exposes individual ports as a workaround.
  # For production use with full RTP range support, consider one of these approaches:
  #   1. Use hostNetwork: true in the deployment (pod uses host networking)
  #   2. Use hostPort configuration for the RTP range
  #   3. Use a DaemonSet with host networking
  #   4. Use a specialized load balancer that supports UDP port ranges
  - name: rtp-start
    port: 10000
    targetPort: 10000
    protocol: UDP
  - name: rtp-end
    port: 20000
    targetPort: 20000
    protocol: UDP
  sessionAffinity: ClientIP
  sessionAffinityConfig:
    clientIP:
      timeoutSeconds: 10800  # 3 hours
---
# PostgreSQL Service (Headless)
# NOTE: This service requires a corresponding PostgreSQL StatefulSet or Deployment
# which is not included in these manifests. You must either:
#   1. Deploy PostgreSQL separately (e.g., using a Helm chart)
#   2. Create a postgresql.yaml manifest with a StatefulSet
#   3. Use an external managed database service
apiVersion: v1
kind: Service
metadata:
  name: pbx-postgresql
  namespace: pbx-system
  labels:
    app: pbx-postgresql
spec:
  type: ClusterIP
  selector:
    app: pbx-postgresql
  ports:
  - name: postgresql
    port: 5432
    targetPort: 5432
    protocol: TCP
  clusterIP: None  # Headless service for StatefulSet
