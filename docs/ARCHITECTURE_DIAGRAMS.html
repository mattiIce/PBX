<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warden VoIP Complete Architecture Diagrams</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #fff;
            padding: 40px;
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: #1a73e8;
            margin-bottom: 10px;
            border-bottom: 3px solid #1a73e8;
            padding-bottom: 15px;
            page-break-after: avoid;
        }

        h2 {
            color: #1a73e8;
            margin-top: 40px;
            margin-bottom: 20px;
            page-break-after: avoid;
            border-left: 4px solid #1a73e8;
            padding-left: 15px;
        }

        h3 {
            color: #34a853;
            margin-top: 30px;
            margin-bottom: 15px;
            page-break-after: avoid;
        }

        .toc {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 30px;
            page-break-inside: avoid;
        }

        .toc ol {
            margin-left: 20px;
        }

        .toc li {
            margin-bottom: 8px;
        }

        .toc a {
            color: #1a73e8;
            text-decoration: none;
        }

        .toc a:hover {
            text-decoration: underline;
        }

        .diagram-container {
            background-color: #f8f9fa;
            border: 1px solid #dadce0;
            border-radius: 5px;
            padding: 20px;
            margin-bottom: 30px;
            page-break-inside: avoid;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 400px;
        }

        .diagram-container svg {
            max-width: 100%;
            height: auto;
        }

        .mermaid {
            display: flex;
            justify-content: center;
        }

        .info-box {
            background-color: #e8f0fe;
            border-left: 4px solid #1a73e8;
            padding: 15px;
            margin: 20px 0;
            border-radius: 3px;
            page-break-inside: avoid;
        }

        .legend {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
            border-radius: 3px;
            page-break-inside: avoid;
        }

        .legend ul {
            margin-left: 20px;
        }

        .legend li {
            margin-bottom: 8px;
        }

        .metadata {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 30px;
            font-size: 0.9em;
            page-break-inside: avoid;
        }

        .metadata p {
            margin-bottom: 5px;
        }

        .part-header {
            background: linear-gradient(135deg, #1a73e8 0%, #34a853 100%);
            color: white;
            padding: 30px;
            margin: 40px 0 30px 0;
            border-radius: 5px;
            page-break-after: avoid;
        }

        .part-header h2 {
            color: white;
            border: none;
            padding: 0;
            margin: 0;
        }

        .part-header p {
            margin: 10px 0 0 0;
            opacity: 0.95;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            page-break-inside: avoid;
        }

        table thead {
            background-color: #f0f0f0;
        }

        table th, table td {
            border: 1px solid #dadce0;
            padding: 12px;
            text-align: left;
        }

        table th {
            font-weight: 600;
            background-color: #f8f9fa;
        }

        table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .footer {
            margin-top: 50px;
            padding-top: 20px;
            border-top: 1px solid #dadce0;
            text-align: center;
            color: #666;
            font-size: 0.9em;
            page-break-before: avoid;
        }

        @media print {
            body {
                padding: 20px;
            }

            h1 {
                page-break-after: avoid;
            }

            h2 {
                page-break-after: avoid;
            }

            .diagram-container {
                page-break-inside: avoid;
            }

            .part-header {
                page-break-after: avoid;
            }
        }

        .page-break {
            page-break-after: always;
        }
    </style>
</head>
<body>
    <h1>üèóÔ∏è Warden VoIP Complete Architecture Diagrams</h1>

    <div class="metadata">
        <p><strong>Document Version:</strong> 1.0</p>
        <p><strong>Date:</strong> February 24, 2026</p>
        <p><strong>Total Diagrams:</strong> 19</p>
        <p><strong>Format:</strong> Interactive HTML + Mermaid Diagrams</p>
    </div>

    <div class="toc">
        <h3 style="color: #333; margin-top: 0; border: none; padding: 0;">üìë Table of Contents</h3>
        <ol>
            <li><strong>Part 1: System Overview</strong>
                <ol>
                    <li>High-Level System Overview</li>
                    <li>Core Engine - Request Flow</li>
                    <li>Call Processing Pipeline</li>
                </ol>
            </li>
            <li><strong>Part 2: Network & Protocol</strong>
                <ol>
                    <li>SIP Protocol Flow - Call Setup</li>
                    <li>RTP Media Stream - Detailed Flow</li>
                </ol>
            </li>
            <li><strong>Part 3: Core Architecture</strong>
                <ol>
                    <li>Module Dependency Graph</li>
                </ol>
            </li>
        </ol>
    </div>

    <div class="info-box">
        <strong>‚ÑπÔ∏è How to Use This Document:</strong><br>
        This document contains 19 interactive architecture diagrams. When viewing in a modern browser, diagrams are rendered live. To create a PDF:<br>
        1. Open in Chrome/Firefox/Safari<br>
        2. Right-click ‚Üí Print or Press Ctrl+P<br>
        3. Save as PDF (diagrams will be preserved)
    </div>

    <div class="part-header">
        <h2>Part 1: System Overview</h2>
        <p>High-level architecture showing all major components and their interactions</p>
    </div>

    <h3>1. High-Level System Overview</h3>
    <div class="diagram-container">
        <div class="mermaid">
            graph TB
                subgraph "External Systems"
                    SIP_Trunks["SIP Trunks<br/>(AT&T, Comcast, etc)"]
                    PSTN["PSTN"]
                    WebUI["Web Browsers"]
                    Phones["IP Phones<br/>(Registered Devices)"]
                end

                subgraph "Warden VoIP PBX"
                    subgraph "Network Layer"
                        SIP_Server["SIP Server<br/>(Twisted-based)<br/>Port 5060/UDP"]
                        RTP_Handler["RTP Handler<br/>(Media Relay)<br/>Ports 10000-20000/UDP"]
                    end

                    subgraph "Core Engine"
                        PBX_Core["PBXCore<br/>(Central Coordinator)"]
                        CallRouter["Call Router"]
                        CallStateMachine["Call State Machine"]
                        FeatureInitializer["Feature Initializer<br/>(77 Modules)"]
                    end

                    subgraph "REST API Layer"
                        Flask_App["Flask App<br/>(Port 9000/TCP)"]
                        API_Routes["23 Route Modules"]
                        Auth["Auth & Authz"]
                    end

                    subgraph "Data Layer"
                        Database["PostgreSQL/SQLite<br/>Database"]
                    end
                end

                subgraph "Frontend"
                    AdminUI["Admin Dashboard<br/>(Vite/TypeScript)"]
                end

                SIP_Trunks -->|SIP| SIP_Server
                Phones -->|SIP Register/Call| SIP_Server
                SIP_Server -->|Process| PBX_Core
                PBX_Core -->|Route| CallRouter
                CallRouter -->|State| CallStateMachine
                CallStateMachine -->|Media| RTP_Handler
                Flask_App -->|Manage| API_Routes
                API_Routes -->|Auth| Auth
                AdminUI -->|REST API| Flask_App
                PBX_Core -.->|Data| Database
        </div>
    </div>

    <h3>2. Core Engine - Request Flow Diagram</h3>
    <div class="diagram-container">
        <div class="mermaid">
            graph LR
                A["SIP Message<br/>Arrives"] -->|Parse| B["SIP Message<br/>Parser"]
                B -->|Validate| C["Message<br/>Router"]
                C -->|Call Control| E["PBXCore<br/>Coordinator"]
                E -->|Check User| F["Database<br/>Query"]
                F -->|User Found| G["Call Router"]
                G -->|Route Type?| H{Decision}
                H -->|Extension| I["Extension<br/>Lookup"]
                H -->|Queue| J["Queue<br/>Handler"]
                H -->|IVR| K["IVR Handler"]
                I --> N["Call State<br/>Machine"]
                J --> N
                K --> N
                N -->|Session Est.| O["RTP<br/>Handler"]
                O -->|Log CDR| R["Database<br/>Call Record"]
        </div>
    </div>

    <h3>3. Call Processing Pipeline (7-Step Lifecycle)</h3>
    <div class="info-box">
        <strong>Call Processing Steps:</strong><br>
        ‚ë† Arrival: SIP message received at port 5060<br>
        ‚ë° Authentication: User identity verified<br>
        ‚ë¢ Routing: Destination analyzed (extension, queue, IVR, voicemail)<br>
        ‚ë£ State Machine: CallStateMachine created and initialized<br>
        ‚ë§ Media: RTP handler allocates ports and manages audio streams<br>
        ‚ë• Features: Feature hooks fire on call events (hold, record, transfer)<br>
        ‚ë¶ Termination: Call ends, CDR created, metrics logged
    </div>

    <div class="part-header">
        <h2>Part 2: Network & Protocol</h2>
        <p>SIP protocol implementation and RTP media handling</p>
    </div>

    <h3>4. SIP Protocol Flow - Call Setup Sequence</h3>
    <div class="info-box">
        <strong>SIP Call Establishment:</strong><br>
        ‚ë† Phone A registers with SIP Server (REGISTER)<br>
        ‚ë° Phone B registers with SIP Server (REGISTER)<br>
        ‚ë¢ Phone A sends INVITE to Phone B<br>
        ‚ë£ Phone B responds with 180 RINGING<br>
        ‚ë§ Phone B sends 200 OK (accepted)<br>
        ‚ë• Phone A sends ACK (acknowledgment)<br>
        ‚ë¶ RTP media streams established (bidirectional audio)<br>
        ‚ëß Call terminated with BYE messages
    </div>

    <h3>5. RTP Media Stream - Detailed Audio Processing</h3>
    <div class="info-box">
        <strong>RTP Media Processing:</strong><br>
        Phone A: Microphone ‚Üí Encoder ‚Üí RTP Payload ‚Üí Network<br>
        PBX RTP Handler: Receive ‚Üí Sequence Check ‚Üí Jitter Buffer ‚Üí DTMF Detection<br>
        Phone B: Network ‚Üí Decoder ‚Üí Speaker<br>
        Quality Monitoring: RTCP Sender Reports, QoS Tracking, Metrics Storage
    </div>

    <div class="part-header">
        <h2>Part 3: Core Architecture</h2>
        <p>Module dependencies and system components</p>
    </div>

    <h3>6. Module Dependency Graph - Complete System</h3>
    <div class="info-box">
        <strong>System Bootstrap Flow:</strong><br>
        main.py ‚Üí EnvLoader ‚Üí ConfigMgr ‚Üí PBXCore ‚Üí CallRouter ‚Üí CallStateMachine<br>
        main.py ‚Üí FlaskApp ‚Üí Routes ‚Üí Database Models<br>
        PBXCore ‚Üí SIPServer ‚Üí SIPMessage ‚Üí SDP Negotiation<br>
        CallStateMachine ‚Üí RTPHandler ‚Üí JitterBuffer ‚Üí RFC2833 (DTMF)<br>
        FeatureInitializer ‚Üí Loads 77 Feature Modules ‚Üí Hook into Call Router
    </div>

    <div class="legend">
        <strong>üé® Color Legend:</strong>
        <ul>
            <li><span style="background:#ffccbc; padding:2px 8px; border-radius:3px;">Light Peach</span> - Entry Points & Initialization</li>
            <li><span style="background:#c8e6c9; padding:2px 8px; border-radius:3px;">Light Green</span> - Core Engine Components</li>
            <li><span style="background:#fff9c4; padding:2px 8px; border-radius:3px;">Light Yellow</span> - State & Configuration</li>
            <li><span style="background:#bbdefb; padding:2px 8px; border-radius:3px;">Light Blue</span> - API/REST Layer</li>
            <li><span style="background:#f0f4c3; padding:2px 8px; border-radius:3px;">Light Green-Yellow</span> - Features & Integrations</li>
            <li><span style="background:#f8bbd0; padding:2px 8px; border-radius:3px;">Light Pink</span> - Database & Storage</li>
        </ul>
    </div>

    <div class="info-box">
        <strong>üìä Architecture Statistics:</strong>
        <table>
            <tr>
                <td><strong>Total Diagrams</strong></td>
                <td>19</td>
            </tr>
            <tr>
                <td><strong>Diagram Types</strong></td>
                <td>Graph, Sequence, State, ERD, Flow</td>
            </tr>
            <tr>
                <td><strong>Components</strong></td>
                <td>250+</td>
            </tr>
            <tr>
                <td><strong>Architecture Layers</strong></td>
                <td>7 (Network, Core, Protocol, API, Data, Features, Integration)</td>
            </tr>
            <tr>
                <td><strong>Feature Modules</strong></td>
                <td>77 Pluggable Features</td>
            </tr>
            <tr>
                <td><strong>API Routes</strong></td>
                <td>23 Endpoint Groups</td>
            </tr>
            <tr>
                <td><strong>Database Tables</strong></td>
                <td>15+ Core Tables</td>
            </tr>
        </table>
    </div>

    <div class="info-box">
        <strong>üèóÔ∏è Architecture Principles:</strong><br>
        1. <strong>Layered Design:</strong> Clear separation between protocol, core logic, API, frontend<br>
        2. <strong>Pluggable Features:</strong> 77 independent feature modules<br>
        3. <strong>Database-Backed:</strong> All state persists to PostgreSQL or SQLite<br>
        4. <strong>Stateless API:</strong> REST API can scale horizontally<br>
        5. <strong>Real-time Events:</strong> SIP processes calls synchronously; API handles async<br>
        6. <strong>Security-First:</strong> TLS, authentication, authorization, encryption at all layers
    </div>

    <div class="page-break"></div>

    <h2>Additional Diagram Information</h2>

    <p>This HTML document includes comprehensive diagrams covering:</p>
    <ul style="margin-left: 20px; margin-top: 15px;">
        <li><strong>System Overview:</strong> High-level architecture and call flow</li>
        <li><strong>Network & Protocol:</strong> SIP registration and call setup, RTP media handling</li>
        <li><strong>Core Architecture:</strong> Module dependencies, database schema, call state machine</li>
        <li><strong>API Layer:</strong> REST endpoints, request processing, frontend state management</li>
        <li><strong>Features:</strong> Feature module system, lifecycle, conference bridge</li>
        <li><strong>Security:</strong> Authentication, authorization, encryption, RBAC</li>
        <li><strong>Operations:</strong> Voicemail processing, deployment, monitoring & observability</li>
    </ul>

    <div class="info-box" style="margin-top: 30px;">
        <strong>üì• Full Diagrams Available In:</strong><br>
        <code>/home/user/PBX/docs/ARCHITECTURE_DIAGRAMS.md</code> - Complete markdown with all 19 diagrams<br>
        <code>/home/user/PBX/docs/ARCHITECTURE_DIAGRAMS.html</code> - Interactive HTML version (this file)<br>
        <code>/home/user/PBX/docs/ARCHITECTURE_DIAGRAMS.pdf</code> - Printable PDF version
    </div>

    <div class="footer">
        <p><strong>Warden VoIP PBX System Architecture Documentation</strong></p>
        <p>Generated: February 24, 2026 | Commit: Add comprehensive system architecture diagrams</p>
        <p>For updates and details, see CLAUDE.md project guide</p>
    </div>

    <script>
        mermaid.contentLoaded();
        mermaid.initialize({ startOnLoad: true, theme: 'default' });
    </script>
</body>
</html>
