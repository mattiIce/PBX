# Comcast Business VoiceEdge SIP Trunk Configuration Template
# This configuration is for Comcast Business VoiceEdge (PRI-over-SIP)
# 
# Prerequisites:
# - Comcast Business VoiceEdge account
# - Static IP address from Comcast Business Internet
# - Comcast-provided SIP credentials
# - Network equipment capable of QoS
#
# Comcast Documentation: https://business.comcast.com/learn/phone/voiceedge

# ============================================================
# Server Configuration
# ============================================================
server:
  sip_host: "0.0.0.0"           # Listen on all interfaces
  sip_port: 5060                # Standard SIP port
  public_ip: "YOUR_PUBLIC_IP"   # Your Comcast static IP
  
  # RTP port range for media
  rtp_port_range_start: 16384   # Comcast recommended range
  rtp_port_range_end: 32767     # Comcast recommended range

# ============================================================
# Comcast SIP Trunk Configuration
# ============================================================
sip_trunks:
  - id: comcast_primary
    name: "Comcast VoiceEdge Primary"
    
    # Comcast SIP proxy addresses (regional - check with Comcast)
    # Common Comcast SIP domains:
    # - sip.voiceedge.com (national)
    # - Regional format: sip-XX.voipinterface.com (where XX is region code)
    host: "sip.voiceedge.com"    # Comcast SIP proxy
    port: 5060                    # Standard SIP port
    
    # Alternative hosts (region-specific examples)
    # host: "sip-ca.voipinterface.com"      # California
    # host: "sip-fl.voipinterface.com"      # Florida
    # host: "sip-il.voipinterface.com"      # Illinois
    # host: "sip-ma.voipinterface.com"      # Massachusetts
    # host: "sip-tx.voipinterface.com"      # Texas
    
    # Authentication - Comcast typically uses IP-based auth
    # Some accounts may require username/password
    username: "YOUR_COMCAST_USERNAME"      # From Comcast (if required)
    password: "YOUR_COMCAST_PASSWORD"      # From Comcast (if required)
    auth_realm: "voiceedge.com"            # Comcast SIP realm
    
    # Trunk settings
    max_channels: 23              # Adjust based on your PRI/SIP channel count
    codec_preferences:
      - "G.711u"                  # Comcast primary codec (PCMU)
      - "G.729"                   # Compressed codec (if enabled by Comcast)
    
    # Comcast specific settings
    registration_required: false  # Comcast typically uses IP auth, not registration
    keep_alive_interval: 30       # Send OPTIONS keepalive
    session_timers: true          # Enable SIP session timers
    session_expires: 1800         # Session refresh interval
    
    # SIP transport
    transport: "UDP"              # Comcast uses UDP
    
    # Caller ID settings
    from_domain: "voiceedge.com"  # Or your custom domain if configured
    
  # Optional: Backup trunk for redundancy
  - id: comcast_backup
    name: "Comcast VoiceEdge Backup"
    host: "sip-backup.voiceedge.com"
    port: 5060
    max_channels: 23
    codec_preferences:
      - "G.711u"
      - "G.729"
    registration_required: false
    transport: "UDP"

# ============================================================
# Outbound Routing Rules for Comcast
# ============================================================
outbound_routes:
  # Emergency calls (911)
  - id: emergency
    name: "Emergency - 911"
    pattern: "^911$"
    trunk_id: comcast_primary
    priority: 1
    
  # Enhanced 911 (with callback number)
  - id: enhanced_911
    name: "Enhanced 911"
    pattern: "^[0-9]*911$"        # Allows prefix for location tracking
    trunk_id: comcast_primary
    priority: 1
    
  # Toll-free numbers (1-8XX)
  - id: tollfree
    name: "Toll-Free Numbers"
    pattern: "^1[8][0-9]{2}[0-9]{7}$"
    trunk_id: comcast_primary
    priority: 2
    
  # Long distance (1 + 10 digits)
  - id: long_distance
    name: "US/Canada Long Distance"
    pattern: "^1[2-9][0-9]{9}$"
    trunk_id: comcast_primary
    priority: 3
    
  # Local 10-digit dialing
  - id: local_10digit
    name: "Local 10-Digit"
    pattern: "^[2-9][0-9]{9}$"
    trunk_id: comcast_primary
    prepend: "1"                  # Comcast requires leading 1
    priority: 4
    
  # Local 7-digit dialing (if allowed in your area)
  - id: local_7digit
    name: "Local 7-Digit"
    pattern: "^[2-9][0-9]{6}$"
    trunk_id: comcast_primary
    prepend: "1YOUR_AREA_CODE"    # Add 1 + area code
    priority: 5
    
  # International calls (011 + country code)
  - id: international
    name: "International Calls"
    pattern: "^011[0-9]{8,15}$"
    trunk_id: comcast_primary
    priority: 6
    
  # 411 Directory Assistance
  - id: directory
    name: "Directory Assistance"
    pattern: "^411$"
    trunk_id: comcast_primary
    priority: 7

# ============================================================
# Inbound DID (Direct Inward Dialing) Routing
# ============================================================
inbound_routes:
  # Main business number
  - did: "+1234567890"            # Your main Comcast number
    destination: "1000"           # Receptionist or auto-attendant
    description: "Main Line"
    
  # Department DIDs
  - did: "+1234567891"
    destination: "8001"           # Sales queue
    description: "Sales"
    
  - did: "+1234567892"
    destination: "8002"           # Support queue
    description: "Support"
    
  # DID range routing
  - did_pattern: "+123456789[0-9]"
    destination_type: "extension"
    strip_prefix: "+123456789"    # Map last digit to extension
    description: "DID Range"
    
  # Fax line (if using T.38)
  - did: "+1234567899"
    destination: "fax_server"
    description: "Fax Line"

# ============================================================
# Comcast Network Settings
# ============================================================
network:
  # Comcast SIP/Media Server IPs (check with Comcast for current ranges)
  signaling:
    allowed_ips:
      - "69.252.0.0/16"           # Comcast SIP servers
      - "96.114.0.0/16"           # Comcast network range
      - "24.128.0.0/16"           # Comcast network range
      - "98.192.0.0/16"           # Comcast network range
    
  media:
    allowed_ips:
      - "69.252.0.0/16"           # Comcast RTP servers
      - "96.114.0.0/16"
      - "24.128.0.0/16"
      - "98.192.0.0/16"
  
  # NAT settings (usually not needed with Comcast Business static IP)
  nat:
    enabled: false                # Disable if using Comcast static IP directly
    public_ip: "YOUR_PUBLIC_IP"

# ============================================================
# QoS (Quality of Service) Settings - CRITICAL for Comcast
# ============================================================
# Comcast Business requires proper QoS markings for best call quality
qos:
  enabled: true
  sip_dscp: 26                    # AF31 for SIP signaling
  rtp_dscp: 46                    # EF (Expedited Forwarding) for voice RTP
  
  # Comcast QoS recommendations
  voice_priority: "high"
  bandwidth_reservation:
    per_call_kbps: 85             # ~64kbps for G.711 + overhead

# ============================================================
# Codec Configuration
# ============================================================
codecs:
  - name: "G.711u"                # PCMU - Primary codec for Comcast
    enabled: true
    priority: 1
    ptime: 20                     # 20ms packet size (Comcast default)
    
  - name: "G.729"                 # Compressed codec (check if enabled)
    enabled: false                # Enable only if Comcast supports it
    priority: 2
    ptime: 20
    
  # Note: Comcast typically only supports G.711u (PCMU)
  # Contact Comcast if you need G.729 or other codecs

# ============================================================
# Comcast-Specific Features
# ============================================================
comcast_features:
  # Caller ID Name (CNAM)
  cnam:
    enabled: true
    display_format: "full"        # Show full caller name
  
  # E911 Emergency Services
  e911:
    enabled: true
    provider: "comcast"
    # Comcast manages E911 database centrally
    locations:
      - extension_range: "1000-1099"
        address: "123 Main St"
        suite: "Suite 100"
        city: "Your City"
        state: "CA"
        zip: "12345"
        
      - extension_range: "1100-1199"
        address: "456 Oak Ave"
        city: "Your City"
        state: "CA"
        zip: "12345"
  
  # Call Features
  call_features:
    call_waiting: true
    call_forwarding: true
    call_transfer: true
    conference: true              # 3-way calling
    voicemail: false              # Using PBX voicemail instead
    
  # Music on Hold
  moh:
    enabled: true
    source: "internal"            # Use PBX MOH instead of Comcast
  
  # Fax Support (T.38)
  fax:
    enabled: false                # Enable if you need fax
    protocol: "T.38"
    fallback_to_passthrough: true # Fall back to G.711 if T.38 fails

# ============================================================
# Security Settings
# ============================================================
security:
  # IP-based authentication (Comcast uses IP whitelisting)
  ip_authentication:
    enabled: true
    allowed_ips:                  # Only accept calls from Comcast IPs
      - "69.252.0.0/16"
      - "96.114.0.0/16"
      - "24.128.0.0/16"
      - "98.192.0.0/16"
  
  # SIP security
  sip_security:
    check_from_domain: true
    allowed_domains:
      - "voiceedge.com"
      - "voipinterface.com"
      - "comcast.net"
  
  # Toll fraud prevention
  fraud_prevention:
    enabled: true
    max_calls_per_minute: 20
    max_international_calls_per_hour: 10
    block_premium_rate: true      # Block 900 numbers
    allowed_patterns:             # Additional restrictions
      - "^1?[2-9][0-9]{9}$"      # North American numbers only
      - "^911$"                   # Emergency
      - "^411$"                   # Directory

# ============================================================
# SIP Header Manipulation (for Comcast compatibility)
# ============================================================
sip_headers:
  # Comcast may require specific headers
  custom_headers:
    - name: "X-Comcast-Account"
      value: "YOUR_ACCOUNT_NUMBER"
    
  # User-Agent customization
  user_agent: "PBX-ComcastVE/1.0"
  
  # P-Asserted-Identity for caller ID
  pai_enabled: true

# ============================================================
# Monitoring and Logging
# ============================================================
logging:
  level: "INFO"
  file: "logs/pbx_comcast.log"
  sip_trace: true
  sip_trace_file: "logs/sip_comcast.log"
  
  # Call quality monitoring
  quality_monitoring:
    enabled: true
    log_poor_quality: true
    jitter_threshold_ms: 30
    packet_loss_threshold: 3      # Percent

monitoring:
  enabled: true
  trunk_status_check: 30          # Check every 30 seconds
  alert_on_trunk_down: true
  alert_email: "admin@yourcompany.com"
  
  # Comcast service health checks
  health_checks:
    options_ping: true            # Send OPTIONS to keep connection alive
    ping_interval: 30
    
  # Call Detail Records
  cdr:
    enabled: true
    log_all_calls: true
    include_sip_headers: true

# ============================================================
# Bandwidth Management
# ============================================================
bandwidth:
  # Calculate based on: (calls * 85 kbps) for G.711
  # Example: 23 channels * 85 kbps = ~2 Mbps
  max_concurrent_calls: 23
  per_call_bandwidth_kbps: 85
  total_bandwidth_reservation_kbps: 1955
  
  # Bandwidth limits per trunk
  trunks:
    - trunk_id: comcast_primary
      max_bandwidth_kbps: 1955
      bandwidth_management: "strict"

# ============================================================
# Extensions (Sample)
# ============================================================
extensions:
  - number: "1000"
    name: "Receptionist"
    email: "reception@yourcompany.com"
    password: "secure_password_here"
    allow_external: true
    
  - number: "1001"
    name: "John Doe"
    email: "john@yourcompany.com"
    password: "secure_password_here"
    allow_external: true

# ============================================================
# Advanced Settings
# ============================================================
advanced:
  # DTMF Handling
  dtmf:
    mode: "RFC2833"               # Comcast preferred DTMF method
    fallback: "inband"            # Fall back to inband if RFC2833 fails
    
  # SIP Timers
  timers:
    t1: 500                       # RTT estimate (ms)
    t2: 4000                      # Max retransmit interval (ms)
    t4: 5000                      # Max duration message (ms)
    
  # RTP Settings
  rtp:
    timeout: 30                   # RTP timeout in seconds
    hold_timeout: 1800            # Max hold time (30 min)
    comfort_noise: true           # Send comfort noise during silence

# ============================================================
# Comcast Gateway/Equipment Settings
# ============================================================
# If using Comcast-provided equipment (EMG, etc.)
comcast_equipment:
  type: "none"                    # Options: "none", "emg", "ata"
  
  # If using EMG (Enterprise Media Gateway)
  emg:
    enabled: false
    ip: "192.168.1.1"
    management_port: 443
    
  # If using Comcast ATA
  ata:
    enabled: false
    ip: "192.168.1.2"

# ============================================================
# Notes and Important Information
# ============================================================
# 
# SETUP STEPS:
# 1. Contact Comcast Business to provision VoiceEdge SIP service
# 2. Obtain SIP proxy addresses and credentials from Comcast
# 3. Update all "YOUR_*" placeholders in this config
# 4. Configure router for proper QoS (DSCP markings)
# 5. Set up firewall rules (usually minimal with Comcast Business)
# 6. Register your equipment MAC/IP with Comcast if required
# 7. Test emergency services (911) in coordination with Comcast
# 
# IMPORTANT QoS CONFIGURATION:
# Comcast Business VoiceEdge REQUIRES proper QoS configuration
# - Mark SIP traffic with DSCP AF31 (26)
# - Mark RTP traffic with DSCP EF (46)
# - Configure bandwidth reservation on router
# - Enable QoS on all network switches
# 
# FIREWALL RULES:
# - Allow UDP 5060 from Comcast IPs (SIP signaling)
# - Allow UDP 16384-32767 from Comcast IPs (RTP media)
# - Typically no NAT required with Comcast Business static IP
# 
# COMCAST SUPPORT:
# - Business Support: 1-800-391-3000
# - Technical Support: Available 24/7 through business portal
# - Online Portal: https://business.comcast.com
# 
# REGIONAL SIP SERVERS:
# Contact Comcast to get the correct regional SIP server for your area
# Using the geographically closest server improves call quality
# 
# TESTING CHECKLIST:
# □ Test inbound calls to all DIDs
# □ Test outbound local calls
# □ Test outbound long distance
# □ Test 911 emergency services (coordinate with Comcast)
# □ Verify caller ID on both inbound and outbound
# □ Test call quality (listen for jitter, latency, packet loss)
# □ Test call features (hold, transfer, conference)
# □ Test fax if applicable
# □ Monitor first 24-48 hours for any issues
# 
# TROUBLESHOOTING:
# - One-way audio? Check firewall/NAT/RTP ports
# - Poor call quality? Verify QoS configuration
# - Registration failing? Check IP whitelist with Comcast
# - Calls dropping? Check session timer settings
# - No dial tone? Verify trunk status and codec support
